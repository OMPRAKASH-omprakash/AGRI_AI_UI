<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Agri-Assistant</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #e0f2fe, #f0fdf4, #fefce8);
            color: #1e3a8a; /* A darker blue for better contrast */
        }
        .main-container {
            max-width: 1400px;
            height: calc(100vh - 2rem);
        }
        .chat-container {
            background-color: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(10px);
            border-radius: 1.5rem; /* More rounded */
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.15);
            display: flex;
            flex-direction: column;
            height: 100%;
        }
        .message-box {
            padding: 0.75rem 1.25rem;
            margin-bottom: 0.75rem;
            max-width: 80%;
            word-wrap: break-word;
            position: relative;
            border-radius: 1rem;
            animation: message-fade-in 0.4s ease-out forwards;
            opacity: 0;
            transform: translateY(10px);
        }
        
        @keyframes message-fade-in {
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .user-message {
            background: linear-gradient(120deg, #3b82f6, #60a5fa);
            color: #ffffff;
            align-self: flex-end;
            border-bottom-right-radius: 0.25rem;
            box-shadow: 0 2px 4px rgba(59, 130, 246, 0.2);
        }
        .ai-message {
            background-color: #ffffff;
            color: #374151;
            align-self: flex-start;
            border: 1px solid #e5e7eb;
            border-bottom-left-radius: 0.25rem;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }
        .ai-message h3 { font-size: 1.1rem; font-weight: bold; margin-bottom: 0.5rem; color: #1d4ed8; }
        .ai-message ul { list-style-type: 'üåø'; padding-left: 1.5rem; margin-top: 0.5rem; }
        .ai-message li { margin-bottom: 0.25rem; padding-left: 0.5rem; }
        .message-box strong { display: block; font-size: 0.8rem; color: rgba(255,255,255,0.8); }
        .ai-message strong { color: #4b5563; }

        .btn-primary, .btn-secondary {
            transition: all 0.3s ease;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .btn-primary:hover, .btn-secondary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.15);
        }
        
        #loading-modal .loader {
            display: flex;
            gap: 0.5rem;
        }
        #loading-modal .dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background-color: #3b82f6;
            animation: pulse 1.5s infinite ease-in-out;
        }
        #loading-modal .dot:nth-child(2) { animation-delay: 0.2s; }
        #loading-modal .dot:nth-child(3) { animation-delay: 0.4s; }
        @keyframes pulse {
            0%, 100% { transform: scale(0.8); opacity: 0.7; }
            50% { transform: scale(1.2); opacity: 1; }
        }
        
        #sidebar { 
            transition: transform 0.3s ease-in-out; 
            background-color: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(5px);
            border-right: 1px solid rgba(255, 255, 255, 0.3);
        }
        .ai-message-controls {
            position: absolute; bottom: 8px; right: 8px;
            display: flex;
            gap: 4px;
        }
        .control-button {
            background: #e5e7eb;
            border-radius: 50%; width: 28px; height: 28px;
            display: flex; align-items: center; justify-content: center;
            cursor: pointer; border: none;
            transition: background-color 0.2s;
        }
        .control-button:hover { background-color: #d1d5db; }
        
        #voice-modal { background-color: rgba(0, 0, 0, 0.85); backdrop-filter: blur(5px); }
        .voice-wave {
            width: 80px; height: 80px; border-radius: 50%;
            background: conic-gradient(#3b82f6 0%, #a855f7 50%, #3b82f6 100%);
            animation: wave 1.5s linear infinite, pulse-voice 2s infinite ease-in-out;
            position: relative;
            display: flex; justify-content: center; align-items: center;
        }
        .voice-wave-inner {
            width: 65px; height: 65px; border-radius: 50%;
            background-color: #1e3a8a;
        }
        @keyframes wave {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        @keyframes pulse-voice {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }
        #stop-voice-button {
            background-color: #ef4444; color: white;
            width: 60px; height: 60px; border-radius: 50%;
            display: flex; justify-content: center; align-items: center;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
            transition: background-color 0.2s, transform 0.2s;
        }
        #stop-voice-button:hover { background-color: #dc2626; transform: scale(1.1); }
        .info-card {
            background-color: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.1);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        .info-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 36px 0 rgba(31, 38, 135, 0.15);
        }
        .info-card h3 {
            background: linear-gradient(120deg, #1e3a8a, #2563eb);
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        #api-status-button {
            transition: all 0.3s ease;
        }
        .message-content { padding-right: 4.5rem; /* Space for buttons */ }
        .translate-popup {
            position: absolute;
            bottom: 40px;
            right: 0;
            background-color: white;
            border: 1px solid #ccc;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 10;
            display: flex;
            flex-direction: column;
            padding: 4px;
            animation: popup-fade-in 0.2s ease-out;
        }
        @keyframes popup-fade-in { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        .translate-popup button {
            background: none;
            border: none;
            text-align: left;
            padding: 6px 12px;
            cursor: pointer;
            border-radius: 4px;
            font-size: 14px;
        }
        .translate-popup button:hover { background-color: #f3f4f6; }
    </style>
</head>
<body class="p-4">
    <div class="main-container mx-auto flex gap-4">

        <aside id="sidebar" class="p-4 rounded-2xl flex-col w-64 absolute md:relative z-20 md:transform-none -translate-x-full">
            <button id="new-chat-button" class="w-full text-left p-3 mb-4 rounded-xl hover:bg-blue-100 font-semibold flex items-center gap-3 text-gray-700 transition-colors">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-blue-600" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd" /></svg>
                <span data-translate="new_chat">New Chat</span>
            </button>
            <div class="relative mb-4">
                <input type="text" id="search-chats" data-translate-placeholder="search_placeholder" placeholder="Search..." class="w-full p-2 border rounded-lg text-sm pl-8 focus:ring-2 focus:ring-blue-400 transition">
                <svg class="w-4 h-4 absolute top-1/2 left-2.5 -translate-y-1/2 text-gray-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
            </div>
            <h3 data-translate="recent" class="text-sm font-bold text-gray-500 uppercase px-2 mb-2">Recent</h3>
            <div id="recent-chats-list" class="flex-1 overflow-y-auto space-y-1"></div>
        </aside>

        <main class="flex-1 flex flex-col md:flex-row gap-4">
            <button id="menu-toggle" class="md:hidden absolute top-4 left-4 z-30 p-2 bg-white rounded-full shadow-md">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" /></svg>
            </button>

            <div class="flex-1 flex flex-col gap-4">
                 <div class="flex justify-between items-start">
                    <div class="text-center md:text-left">
                        <h1 class="text-4xl font-bold" data-translate="title" style="background: linear-gradient(120deg, #1e3a8a, #2563eb, #3b82f6); -webkit-background-clip: text; background-clip: text; -webkit-text-fill-color: transparent;">Agri-Assistant</h1>
                        <p id="user-id" class="text-sm font-medium mt-2 text-gray-500">Connecting...</p>
                    </div>
                    <button id="api-status-button" class="flex items-center gap-2 text-sm font-semibold text-gray-600 bg-white/80 backdrop-blur-sm py-2 px-4 rounded-lg shadow-md hover:shadow-lg hover:bg-gray-50">
                        <span id="api-status-indicator" class="w-3 h-3 rounded-full bg-yellow-500 animate-pulse"></span>
                        <span id="api-status-text">Checking API...</span>
                    </button>
                </div>
                <div class="chat-container flex flex-col p-4 flex-1 overflow-hidden">
                    <div id="chat-history" class="flex-1 overflow-y-auto pr-4 mb-4 space-y-4"></div>
                    <div class="flex items-center space-x-2 border-t pt-4 mt-auto">
                        <select id="language-select" class="p-2 border rounded-lg text-sm bg-gray-50 focus:ring-2 focus:ring-blue-400 transition">
                            <option value="en-US" data-translate="lang_en">English</option>
                            <option value="ml-IN" data-translate="lang_ml">‡¥Æ‡¥≤‡¥Ø‡¥æ‡¥≥‡¥Ç</option>
                            <option value="hi-IN" data-translate="lang_hi">‡§π‡§ø‡§Ç‡§¶‡•Ä</option>
                            <option value="ta-IN" data-translate="lang_ta">‡Æ§‡ÆÆ‡Æø‡Æ¥‡Øç</option>
                        </select>
                         <select id="voice-select" class="p-2 border rounded-lg text-sm bg-gray-50 focus:ring-2 focus:ring-blue-400 transition"></select>
                        <input type="text" id="user-input" data-translate-placeholder="type_query_placeholder" placeholder="Type your query..." class="flex-1 p-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition">
                        <button id="voice-button" class="p-3 rounded-full hover:bg-blue-100 transition-colors">
                           <svg class="mic-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" style="width: 24px; height: 24px; fill: #1e40af;"><path d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3zm5.5-3c0 3.53-2.64 6.44-6.07 6.94V21h-2.87v-3.06c-3.43-.5-6.07-3.41-6.07-6.94h2c0 2.91 2.37 5.26 5.29 5.26S15.5 13.91 15.5 11h2z"/></svg>
                        </button>
                        <button id="send-button" class="btn-primary" style="background: linear-gradient(120deg, #1e40af, #3b82f6); color: #ffffff; padding: 0.75rem 1.5rem; border-radius: 0.75rem;" data-translate="send_button">Send</button>
                    </div>
                    <div class="mt-4 flex flex-col md:flex-row items-center gap-4">
                        <div class="w-full flex items-center gap-2">
                            <label for="image-upload" id="image-upload-label" data-translate="choose_file" class="cursor-pointer text-sm text-blue-700 font-semibold bg-blue-100 hover:bg-blue-200 text-center p-2 rounded-lg whitespace-nowrap transition-colors">Choose file</label>
                            <input type="file" id="image-upload" accept="image/*" class="hidden" />
                            <span id="file-name-display" class="text-sm text-gray-600 truncate"></span>
                        </div>
                        <button id="upload-button" class="btn-primary w-full md:w-auto" style="background: linear-gradient(120deg, #166534, #22c55e); color: #ffffff; padding: 0.5rem 1rem; border-radius: 0.5rem;" data-translate="analyze_image_button">Analyze Image</button>
                        <button id="delete-chat-button" class="btn-primary w-full md:w-auto" style="background: linear-gradient(120deg, #b91c1c, #ef4444); color: #ffffff; padding: 0.5rem 1rem; border-radius: 0.5rem;" data-translate="delete_chat_button">Delete Chat</button>
                    </div>
                </div>
            </div>
            <div class="w-full md:w-1/3 flex flex-col gap-4">
                <div class="info-card bg-white p-4 rounded-2xl text-center">
                    <p id="location-display" class="font-semibold text-lg text-blue-900 mb-1">Loading location...</p>
                    <p id="time-display" class="font-bold text-3xl text-blue-800"></p>
                    <p id="date-display" class="text-sm text-gray-600"></p>
                    <div id="weather-container" class="mt-4 pt-4 border-t border-gray-200 hidden">
                         <div class="flex justify-around items-center text-gray-700">
                             <div class="text-center">
                                 <div id="weather-icon" class="text-4xl animate-pulse"></div>
                                 <p id="weather-desc" class="text-sm font-medium"></p>
                             </div>
                             <div class="text-center">
                                 <p class="text-2xl font-bold" id="temp-c-display">--¬∞C</p>
                                 <p class="text-sm" id="temp-f-display">--¬∞F</p>
                             </div>
                             <div class="space-y-1 text-sm text-left">
                                 <p>üíß <strong data-translate="humidity">Humidity:</strong> <span id="humidity-display">--</span>%</p>
                                 <p>üí® <strong data-translate="wind">Wind:</strong> <span id="wind-display">--</span> km/h</p>
                             </div>
                         </div>
                         <button id="get-location-button" class="mt-3 text-xs text-blue-600 hover:underline hidden">Allow location access for weather</button>
                    </div>
                </div>

                <div class="info-card p-6 rounded-2xl flex flex-col items-center">
                    <h3 class="text-xl font-bold mb-2 text-center" data-translate="terrace_guide_title">Terrace Farming Guide</h3>
                    <p class="text-sm text-gray-700 mb-4 text-center" data-translate="terrace_guide_desc">Discover how to create your own lush garden on a rooftop or balcony.</p>
                    <ul class="text-sm list-disc pl-5 mt-4 text-gray-800 space-y-2">
                        <li><strong data-translate="sunlight">Sunlight:</strong> <span data-translate="sunlight_desc">Ensure your terrace receives at least 5-6 hours of direct sunlight.</span></li>
                        <li><strong data-translate="waterproofing">Waterproofing:</strong> <span data-translate="waterproofing_desc">A critical first step to prevent leaks.</span></li>
                        <li><strong data-translate="potting_mix">Potting Mix:</strong> <span data-translate="potting_mix_desc">Use a lightweight mix to reduce the load on your roof.</span></li>
                        <li><strong data-translate="plant_selection">Plant Selection:</strong> <span data-translate="plant_selection_desc">Choose vegetables like tomatoes, chili, mint, and spinach.</span></li>
                        <li><strong data-translate="pest_control">Pest Control:</strong> <span data-translate="pest_control_desc">Use organic methods like neem oil.</span></li>
                    </ul>
                </div>
                <div class="info-card p-6 rounded-2xl flex flex-col items-center">
                    <h3 class="text-xl font-bold mb-2 text-center" data-translate="contact_title">Need Help? Contact Us! üí¨</h3>
                    <p class="text-sm text-gray-700 mb-4 text-center" data-translate="contact_desc">For any agricultural queries or support, reach out to us!</p>
                    <ul class="text-sm list-disc pl-5 mt-4 text-gray-800 space-y-2">
                        <li><strong data-translate="toll_free">Toll-Free Number:</strong> 1-800-123-4567</li>
                        <li><strong data-translate="email">Email Address:</strong> support@agri-assistant.com</li>
                    </ul>
                </div>
            </div>
        </main>
    </div>

    <div id="loading-modal" class="fixed inset-0 bg-gray-900 bg-opacity-70 flex justify-center items-center hidden z-50">
        <div class="loader">
            <div class="dot"></div>
            <div class="dot"></div>
            <div class="dot"></div>
        </div>
    </div>
    <div id="custom-modal" class="fixed inset-0 bg-gray-900 bg-opacity-50 flex justify-center items-center hidden z-50 p-4">
        <div class="bg-white rounded-lg shadow-xl max-w-sm w-full overflow-hidden transform transition-all animate-fade-in">
            <div id="modal-header" class="p-4">
                 <h3 id="modal-title" class="text-xl font-bold text-white text-center"></h3>
            </div>
            <div class="p-6 text-center">
                <p id="modal-message" class="text-gray-700 mb-6"></p>
                <div class="flex justify-center gap-4">
                    <button id="modal-cancel-button" class="px-6 py-2 rounded-lg bg-gray-200 text-gray-800 hover:bg-gray-300 font-semibold transition-colors">Cancel</button>
                    <button id="modal-ok-button" class="px-6 py-2 rounded-lg text-white font-semibold transition-colors btn-primary">OK</button>
                </div>
            </div>
        </div>
    </div>
    <div id="delete-options-modal" class="fixed inset-0 bg-gray-900 bg-opacity-50 flex justify-center items-center hidden z-50 p-4">
        <div class="bg-white p-6 rounded-lg shadow-xl max-w-sm w-full text-center transform transition-all animate-fade-in">
            <h3 data-translate="delete_options_title" class="text-xl font-bold mb-4">Delete Options</h3>
            <div class="flex flex-col gap-4">
                <button id="delete-this-chat-option-button" data-translate="delete_this_chat_button" class="w-full btn-primary" style="background-color: #1e40af; color: #ffffff; padding: 0.5rem 1rem; border-radius: 0.5rem;">Delete This Chat</button>
                <button id="delete-all-chats-option-button" data-translate="delete_all_chats_button" class="w-full btn-primary" style="background-color: #dc2626; color: #ffffff; padding: 0.5rem 1rem; border-radius: 0.5rem;">Delete All Chats</button>
                <button id="delete-options-cancel-button" data-translate="cancel_button" class="w-full btn-secondary mt-2" style="background-color: #f3f4f6; color: #1f2937; padding: 0.5rem 1rem; border-radius: 0.5rem;">Cancel</button>
            </div>
        </div>
    </div>
    <div id="voice-modal" class="fixed inset-0 justify-center items-center hidden z-50">
        <div class="w-full h-full flex flex-col justify-center items-center relative gap-8">
            <div class="voice-wave"><div class="voice-wave-inner"></div></div>
            <p data-translate="voice_listening" class="text-white text-2xl">Listening...</p>
            <button id="stop-voice-button">
                 <svg class="w-8 h-8" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M6 6h12v12H6z"/></svg>
            </button>
        </div>
    </div>


    <script type="module">
        // The API key is provided automatically by the environment.
        const geminiApiKey = "AIzaSyD3F33tYLAlpIQ2g64T2yhCGRm8c5GlU9o";

        // --- Global Variables ---
        let userId, currentChatId = null, modalAction = null;
        let localChatHistory = [];
        let currentUtterance = null;
        let isVoiceInteraction = false;
        let speechVoices = [];

        // --- Local Storage & User ID Management ---
        const getUserId = () => {
            let id = localStorage.getItem('agri_assistant_user_id');
            if (!id) {
                id = `user_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
                localStorage.setItem('agri_assistant_user_id', id);
            }
            return id;
        };

        const getAllChatsFromStorage = () => {
            const chats = localStorage.getItem(`chats_${userId}`);
            return chats ? JSON.parse(chats) : {};
        };
        
        const saveAllChatsToStorage = (chats) => {
            localStorage.setItem(`chats_${userId}`, JSON.stringify(chats));
        };

        // --- Translation Data ---
        const translations = {
            'en-US': { title: 'Agri-Assistant', new_chat: 'New Chat', search_placeholder: 'Search...', recent: 'Recent', welcome_message: "Welcome! How can I assist?", type_query_placeholder: 'Type your query...', send_button: 'Send', analyze_image_button: 'Analyze Image', delete_chat_button: 'Delete Chat', terrace_guide_title: 'Terrace Farming Guide', terrace_guide_desc: 'Create your own lush garden on a rooftop.', sunlight: 'Sunlight:', sunlight_desc: 'Ensure 5-6 hours of direct sunlight.', waterproofing: 'Waterproofing:', waterproofing_desc: 'A critical first step to prevent leaks.', potting_mix: 'Potting Mix:', potting_mix_desc: 'Use a lightweight mix to reduce roof load.', plant_selection: 'Plant Selection:', plant_selection_desc: 'Choose vegetables like tomatoes, chili, mint.', pest_control: 'Pest Control:', pest_control_desc: 'Use organic methods like neem oil.', contact_title: 'Need Help? Contact Us! üí¨', contact_desc: 'For any agricultural queries, reach out!', toll_free: 'Toll-Free Number:', email: 'Email Address:', delete_options_title: 'Delete Options', delete_this_chat_button: 'Delete This Chat', delete_all_chats_button: 'Delete All Chats', voice_listening: 'Listening...', cancel_button: 'Cancel', ok_button: 'OK', choose_file: 'Choose File', humidity: 'Humidity', wind: 'Wind', lang_en: 'English', lang_ml: 'Malayalam', lang_hi: 'Hindi', lang_ta: 'Tamil' },
            'ta-IN': { title: '‡Æµ‡Øá‡Æ≥‡Ææ‡Æ£‡Øç ‡Æâ‡Æ§‡Æµ‡Æø‡ÆØ‡Ææ‡Æ≥‡Æ∞‡Øç', new_chat: '‡Æ™‡ØÅ‡Æ§‡Æø‡ÆØ ‡Æâ‡Æ∞‡Øà‡ÆØ‡Ææ‡Æü‡Æ≤‡Øç', search_placeholder: '‡Æ§‡Øá‡Æü‡ØÅ...', recent: '‡Æö‡ÆÆ‡ØÄ‡Æ™‡Æ§‡Øç‡Æ§‡Æø‡ÆØ‡Æµ‡Øà', welcome_message: "‡Æµ‡Æ£‡Æï‡Øç‡Æï‡ÆÆ‡Øç! ‡Æé‡Æ™‡Øç‡Æ™‡Æü‡Æø ‡Æâ‡Æ§‡Æµ‡Æü‡Øç‡Æü‡ØÅ‡ÆÆ‡Øç?", type_query_placeholder: '‡Æâ‡Æô‡Øç‡Æï‡Æ≥‡Øç ‡Æµ‡Æø‡Æ©‡Æµ‡Æ≤‡Øà ‡Æ§‡Æü‡Øç‡Æü‡Æö‡Øç‡Æö‡ØÅ ‡Æö‡ØÜ‡ÆØ‡Øç‡Æï...', send_button: '‡ÆÖ‡Æ©‡ØÅ‡Æ™‡Øç‡Æ™‡ØÅ', analyze_image_button: '‡Æ™‡Æü‡Æ§‡Øç‡Æ§‡Øà ‡Æ™‡Æï‡ØÅ‡Æ™‡Øç‡Æ™‡Ææ‡ÆØ‡Øç‡Æµ‡ØÅ ‡Æö‡ØÜ‡ÆØ‡Øç', delete_chat_button: '‡Æâ‡Æ∞‡Øà‡ÆØ‡Ææ‡Æü‡Æ≤‡Øà ‡Æ®‡ØÄ‡Æï‡Øç‡Æï‡ØÅ', terrace_guide_title: '‡ÆÆ‡Øä‡Æü‡Øç‡Æü‡Øà‡ÆÆ‡Ææ‡Æü‡Æø ‡Æµ‡Æø‡Æµ‡Æö‡Ææ‡ÆØ ‡Æµ‡Æ¥‡Æø‡Æï‡Ææ‡Æü‡Øç‡Æü‡Æø', terrace_guide_desc: '‡Æâ‡Æô‡Øç‡Æï‡Æ≥‡Øç ‡ÆÆ‡Øä‡Æü‡Øç‡Æü‡Øà ‡ÆÆ‡Ææ‡Æü‡Æø‡ÆØ‡Æø‡Æ≤‡Øç ‡Æ™‡Æö‡ØÅ‡ÆÆ‡Øà‡ÆØ‡Ææ‡Æ© ‡Æ§‡Øã‡Æü‡Øç‡Æü‡Æ§‡Øç‡Æ§‡Øà ‡Æâ‡Æ∞‡ØÅ‡Æµ‡Ææ‡Æï‡Øç‡Æï‡ØÅ‡Æµ‡Æ§‡ØÅ ‡Æé‡Æ™‡Øç‡Æ™‡Æü‡Æø.', sunlight: '‡Æö‡ØÇ‡Æ∞‡Æø‡ÆØ ‡Æí‡Æ≥‡Æø:', sunlight_desc: '5-6 ‡ÆÆ‡Æ£‡Æø‡Æ®‡Øá‡Æ∞ ‡Æ®‡Øá‡Æ∞‡Æü‡Æø ‡Æö‡ØÇ‡Æ∞‡Æø‡ÆØ ‡Æí‡Æ≥‡Æø ‡Æ§‡Øá‡Æµ‡Øà.', waterproofing: '‡Æ®‡ØÄ‡Æ∞‡Øç‡Æ™‡Øç‡Æ™‡ØÅ‡Æï‡Ææ‡Æ™‡Øç‡Æ™‡ØÅ:', waterproofing_desc: '‡Æï‡Æö‡Æø‡Æµ‡ØÅ‡Æï‡Æ≥‡Øà‡Æ§‡Øç ‡Æ§‡Æü‡ØÅ‡Æï‡Øç‡Æï ‡ÆÆ‡ØÅ‡Æ§‡Æ≤‡Øç ‡Æ™‡Æü‡Æø.', potting_mix: '‡ÆÆ‡Æ£‡Øç ‡Æï‡Æ≤‡Æµ‡Øà:', potting_mix_desc: '‡Æá‡Æ≤‡Æï‡ØÅ‡Æ∞‡Æï ‡Æï‡Æ≤‡Æµ‡Øà‡ÆØ‡Øà‡Æ™‡Øç ‡Æ™‡ÆØ‡Æ©‡Øç‡Æ™‡Æü‡ØÅ‡Æ§‡Øç‡Æ§‡Æµ‡ØÅ‡ÆÆ‡Øç.', plant_selection: '‡Æ§‡Ææ‡Æµ‡Æ∞‡Æ§‡Øç ‡Æ§‡Øá‡Æ∞‡Øç‡Æµ‡ØÅ:', plant_selection_desc: '‡Æ§‡Æï‡Øç‡Æï‡Ææ‡Æ≥‡Æø, ‡ÆÆ‡Æø‡Æ≥‡Æï‡Ææ‡ÆØ‡Øç, ‡Æ™‡ØÅ‡Æ§‡Æø‡Æ©‡Ææ ‡Æ§‡Øá‡Æ∞‡Øç‡Æ®‡Øç‡Æ§‡ØÜ‡Æü‡ØÅ‡Æï‡Øç‡Æï‡Æµ‡ØÅ‡ÆÆ‡Øç.', pest_control: '‡Æ™‡ØÇ‡Æö‡Øç‡Æö‡Æø ‡Æï‡Æü‡Øç‡Æü‡ØÅ‡Æ™‡Øç‡Æ™‡Ææ‡Æü‡ØÅ:', pest_control_desc: '‡Æµ‡Øá‡Æ™‡Øç‡Æ™‡ØÜ‡Æ£‡Øç‡Æ£‡ØÜ‡ÆØ‡Øç ‡Æ™‡Øã‡Æ©‡Øç‡Æ± ‡Æá‡ÆØ‡Æ±‡Øç‡Æï‡Øà ‡ÆÆ‡ØÅ‡Æ±‡Øà‡Æï‡Æ≥‡Øà‡Æ™‡Øç ‡Æ™‡ÆØ‡Æ©‡Øç‡Æ™‡Æü‡ØÅ‡Æ§‡Øç‡Æ§‡Æµ‡ØÅ‡ÆÆ‡Øç.', contact_title: '‡Æâ‡Æ§‡Æµ‡Æø ‡Æ§‡Øá‡Æµ‡Øà‡ÆØ‡Ææ? üí¨', contact_desc: '‡Æµ‡Æø‡Æµ‡Æö‡Ææ‡ÆØ ‡Æµ‡Æø‡Æ©‡Æµ‡Æ≤‡Øç‡Æï‡Æ≥‡ØÅ‡Æï‡Øç‡Æï‡ØÅ, ‡Æé‡Æô‡Øç‡Æï‡Æ≥‡Øà ‡ÆÖ‡Æ£‡ØÅ‡Æï‡Æµ‡ØÅ‡ÆÆ‡Øç!', toll_free: '‡Æá‡Æ≤‡Æµ‡Æö ‡ÆÖ‡Æ¥‡Øà‡Æ™‡Øç‡Æ™‡ØÅ ‡Æé‡Æ£‡Øç:', email: '‡ÆÆ‡Æø‡Æ©‡Øç‡Æ©‡Æû‡Øç‡Æö‡Æ≤‡Øç ‡ÆÆ‡ØÅ‡Æï‡Æµ‡Æ∞‡Æø:', delete_options_title: '‡Æ®‡ØÄ‡Æï‡Øç‡Æï‡ØÅ‡Æ§‡Æ≤‡Øç ‡Æµ‡Æø‡Æ∞‡ØÅ‡Æ™‡Øç‡Æ™‡Æô‡Øç‡Æï‡Æ≥‡Øç', delete_this_chat_button: '‡Æá‡Æ®‡Øç‡Æ§ ‡Æâ‡Æ∞‡Øà‡ÆØ‡Ææ‡Æü‡Æ≤‡Øà ‡Æ®‡ØÄ‡Æï‡Øç‡Æï‡ØÅ', delete_all_chats_button: '‡ÆÖ‡Æ©‡Øà‡Æ§‡Øç‡Æ§‡ØÅ ‡Æâ‡Æ∞‡Øà‡ÆØ‡Ææ‡Æü‡Æ≤‡Øç‡Æï‡Æ≥‡Øà‡ÆØ‡ØÅ‡ÆÆ‡Øç ‡Æ®‡ØÄ‡Æï‡Øç‡Æï‡ØÅ', voice_listening: '‡Æï‡Øá‡Æü‡Øç‡Æï‡Æø‡Æ±‡Æ§‡ØÅ...', cancel_button: '‡Æ∞‡Æ§‡Øç‡Æ§‡ØÅ‡Æö‡ØÜ‡ÆØ‡Øç', ok_button: '‡Æö‡Æ∞‡Æø', choose_file: '‡Æï‡Øã‡Æ™‡Øç‡Æ™‡Øà‡Æ§‡Øç ‡Æ§‡Øá‡Æ∞‡Øç‡Æ®‡Øç‡Æ§‡ØÜ‡Æü‡ØÅ', humidity: '‡Æà‡Æ∞‡Æ™‡Øç‡Æ™‡Æ§‡ÆÆ‡Øç', wind: '‡Æï‡Ææ‡Æ±‡Øç‡Æ±‡ØÅ', lang_en: 'English', lang_ml: '‡¥Æ‡¥≤‡¥Ø‡¥æ‡¥≥‡¥Ç', lang_hi: '‡§π‡§ø‡§Ç‡§¶‡•Ä', lang_ta: '‡Æ§‡ÆÆ‡Æø‡Æ¥‡Øç' },
            'hi-IN': { title: '‡§ï‡•É‡§∑‡§ø-‡§∏‡§π‡§æ‡§Ø‡§ï', new_chat: '‡§®‡§à ‡§ö‡•à‡§ü', search_placeholder: '‡§ñ‡•ã‡§ú‡•á‡§Ç...', recent: '‡§π‡§æ‡§≤ ‡§ï‡•á', welcome_message: "‡§®‡§Æ‡§∏‡•ç‡§§‡•á! ‡§Æ‡•à‡§Ç ‡§ï‡•à‡§∏‡•á ‡§Æ‡§¶‡§¶ ‡§ï‡§∞ ‡§∏‡§ï‡§§‡§æ ‡§π‡•Ç‡§Å?", type_query_placeholder: '‡§Ö‡§™‡§®‡§æ ‡§™‡•ç‡§∞‡§∂‡•ç‡§® ‡§≤‡§ø‡§ñ‡•á‡§Ç...', send_button: '‡§≠‡•á‡§ú‡•á‡§Ç', analyze_image_button: '‡§õ‡§µ‡§ø ‡§ï‡§æ ‡§µ‡§ø‡§∂‡•ç‡§≤‡•á‡§∑‡§£ ‡§ï‡§∞‡•á‡§Ç', delete_chat_button: '‡§ö‡•à‡§ü ‡§π‡§ü‡§æ‡§è‡§Ç', terrace_guide_title: '‡§õ‡§§ ‡§™‡§∞ ‡§ñ‡•á‡§§‡•Ä ‡§ï‡•Ä ‡§ó‡§æ‡§á‡§°', terrace_guide_desc: '‡§è‡§ï ‡§õ‡§§ ‡§™‡§∞ ‡§Ö‡§™‡§®‡§æ ‡§ñ‡•Å‡§¶ ‡§ï‡§æ ‡§π‡§∞‡§æ-‡§≠‡§∞‡§æ ‡§¨‡§ó‡•Ä‡§ö‡§æ ‡§¨‡§®‡§æ‡§è‡§Ç‡•§', sunlight: '‡§ß‡•Ç‡§™:', sunlight_desc: '5-6 ‡§ò‡§Ç‡§ü‡•á ‡§ï‡•Ä ‡§∏‡•Ä‡§ß‡•Ä ‡§ß‡•Ç‡§™ ‡§∏‡•Å‡§®‡§ø‡§∂‡•ç‡§ö‡§ø‡§§ ‡§ï‡§∞‡•á‡§Ç‡•§', waterproofing: '‡§µ‡•â‡§ü‡§∞‡§™‡•ç‡§∞‡•Ç‡§´‡§ø‡§Ç‡§ó:', waterproofing_desc: '‡§≤‡•Ä‡§ï ‡§ï‡•ã ‡§∞‡•ã‡§ï‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è ‡§è‡§ï ‡§Æ‡§π‡§§‡•ç‡§µ‡§™‡•Ç‡§∞‡•ç‡§£ ‡§™‡§π‡§≤‡§æ ‡§ï‡§¶‡§Æ‡•§', potting_mix: '‡§™‡•â‡§ü‡§ø‡§Ç‡§ó ‡§Æ‡§ø‡§ï‡•ç‡§∏:', potting_mix_desc: '‡§õ‡§§ ‡§ï‡§æ ‡§≠‡§æ‡§∞ ‡§ï‡§Æ ‡§ï‡§∞‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è ‡§π‡§≤‡•ç‡§ï‡•á ‡§Æ‡§ø‡§∂‡•ç‡§∞‡§£ ‡§ï‡§æ ‡§â‡§™‡§Ø‡•ã‡§ó ‡§ï‡§∞‡•á‡§Ç‡•§', plant_selection: '‡§™‡•å‡§ß‡•ã‡§Ç ‡§ï‡§æ ‡§ö‡§Ø‡§®:', plant_selection_desc: '‡§ü‡§Æ‡§æ‡§ü‡§∞, ‡§Æ‡§ø‡§∞‡•ç‡§ö, ‡§™‡•Å‡§¶‡•Ä‡§®‡§æ ‡§ú‡•à‡§∏‡•Ä ‡§∏‡§¨‡•ç‡§ú‡§ø‡§Ø‡§æ‡§Ç ‡§ö‡•Å‡§®‡•á‡§Ç‡•§', pest_control: '‡§ï‡•Ä‡§ü ‡§®‡§ø‡§Ø‡§Ç‡§§‡•ç‡§∞‡§£:', pest_control_desc: '‡§®‡•Ä‡§Æ ‡§§‡•á‡§≤ ‡§ú‡•à‡§∏‡•á ‡§ú‡•à‡§µ‡§ø‡§ï ‡§§‡§∞‡•Ä‡§ï‡•ã‡§Ç ‡§ï‡§æ ‡§™‡•ç‡§∞‡§Ø‡•ã‡§ó ‡§ï‡§∞‡•á‡§Ç‡•§', contact_title: '‡§Æ‡§¶‡§¶ ‡§ö‡§æ‡§π‡§ø‡§è? ‡§∏‡§Ç‡§™‡§∞‡•ç‡§ï ‡§ï‡§∞‡•á‡§Ç! üí¨', contact_desc: '‡§ï‡§ø‡§∏‡•Ä ‡§≠‡•Ä ‡§ï‡•É‡§∑‡§ø ‡§™‡•ç‡§∞‡§∂‡•ç‡§® ‡§ï‡•á ‡§≤‡§ø‡§è, ‡§∏‡§Ç‡§™‡§∞‡•ç‡§ï ‡§ï‡§∞‡•á‡§Ç!', toll_free: '‡§ü‡•ã‡§≤-‡§´‡•ç‡§∞‡•Ä ‡§®‡§Ç‡§¨‡§∞:', email: '‡§à‡§Æ‡•á‡§≤ ‡§™‡§§‡§æ:', delete_options_title: '‡§µ‡§ø‡§ï‡§≤‡•ç‡§™ ‡§π‡§ü‡§æ‡§è‡§Ç', delete_this_chat_button: '‡§á‡§∏ ‡§ö‡•à‡§ü ‡§ï‡•ã ‡§π‡§ü‡§æ‡§è‡§Ç', delete_all_chats_button: '‡§∏‡§≠‡•Ä ‡§ö‡•à‡§ü ‡§π‡§ü‡§æ‡§è‡§Ç', voice_listening: '‡§∏‡•Å‡§® ‡§∞‡§π‡§æ ‡§π‡•Ç‡§Å...', cancel_button: '‡§∞‡§¶‡•ç‡§¶ ‡§ï‡§∞‡•á‡§Ç', ok_button: '‡§†‡•Ä‡§ï ‡§π‡•à', choose_file: '‡§´‡§º‡§æ‡§á‡§≤ ‡§ö‡•Å‡§®‡•á‡§Ç', humidity: '‡§®‡§Æ‡•Ä', wind: '‡§π‡§µ‡§æ', lang_en: 'English', lang_ml: 'Malayalam', lang_hi: '‡§π‡§ø‡§Ç‡§¶‡•Ä', lang_ta: '‡Æ§‡ÆÆ‡Æø‡Æ¥‡Øç' },
            'ml-IN': { title: '‡¥Ö‡¥ó‡µç‡¥∞‡¥ø-‡¥Ö‡¥∏‡¥ø‡¥∏‡µç‡¥±‡µç‡¥±‡¥®‡µç‡¥±‡µç', new_chat: '‡¥™‡µÅ‡¥§‡¥ø‡¥Ø ‡¥ö‡¥æ‡¥±‡µç‡¥±‡µç', search_placeholder: '‡¥§‡¥ø‡¥∞‡¥Ø‡µÅ‡¥ï...', recent: '‡¥∏‡¥Æ‡µÄ‡¥™‡¥ï‡¥æ‡¥≤‡¥Ç', welcome_message: "‡¥∏‡µç‡¥µ‡¥æ‡¥ó‡¥§‡¥Ç! ‡¥û‡¥æ‡¥®‡µÜ‡¥ô‡µç‡¥ô‡¥®‡µÜ ‡¥∏‡¥π‡¥æ‡¥Ø‡¥ø‡¥ï‡µç‡¥ï‡µá‡¥£‡µç‡¥ü‡µÅ?", type_query_placeholder: '‡¥®‡¥ø‡¥ô‡µç‡¥ô‡¥≥‡µÅ‡¥ü‡µÜ ‡¥ö‡µã‡¥¶‡µç‡¥Ø‡¥Ç ‡¥ü‡µà‡¥™‡µç‡¥™‡µç ‡¥ö‡µÜ‡¥Ø‡µç‡¥Ø‡µÅ‡¥ï...', send_button: '‡¥Ö‡¥Ø‡¥Ø‡µç‡¥ï‡µç‡¥ï‡µÅ‡¥ï', analyze_image_button: '‡¥ö‡¥ø‡¥§‡µç‡¥∞‡¥Ç ‡¥µ‡¥ø‡¥∂‡¥ï‡¥≤‡¥®‡¥Ç ‡¥ö‡µÜ‡¥Ø‡µç‡¥Ø‡µÅ‡¥ï', delete_chat_button: '‡¥ö‡¥æ‡¥±‡µç‡¥±‡µç ‡¥á‡¥≤‡µç‡¥≤‡¥æ‡¥§‡¥æ‡¥ï‡µç‡¥ï‡µÅ‡¥ï', terrace_guide_title: '‡¥ü‡µÜ‡¥±‡¥∏‡µç ‡¥´‡¥æ‡¥Æ‡¥ø‡¥Ç‡¥ó‡µç ‡¥ó‡µà‡¥°‡µç', terrace_guide_desc: '‡¥í‡¥∞‡µÅ ‡¥Æ‡µá‡µΩ‡¥ï‡µç‡¥ï‡µÇ‡¥∞‡¥Ø‡¥ø‡µΩ ‡¥®‡¥ø‡¥ô‡µç‡¥ô‡¥≥‡µÅ‡¥ü‡µÜ ‡¥∏‡µç‡¥µ‡¥®‡µç‡¥§‡¥Ç ‡¥™‡µÇ‡¥®‡µç‡¥§‡µã‡¥ü‡µç‡¥ü‡¥Ç ‡¥â‡¥£‡µç‡¥ü‡¥æ‡¥ï‡µç‡¥ï‡µÅ‡¥ï.', sunlight: '‡¥∏‡µÇ‡¥∞‡µç‡¥Ø‡¥™‡µç‡¥∞‡¥ï‡¥æ‡¥∂‡¥Ç:', sunlight_desc: '5-6 ‡¥Æ‡¥£‡¥ø‡¥ï‡µç‡¥ï‡µÇ‡µº ‡¥®‡µá‡¥∞‡¥ø‡¥ü‡µç‡¥ü‡µÅ‡¥≥‡µç‡¥≥ ‡¥∏‡µÇ‡¥∞‡µç‡¥Ø‡¥™‡µç‡¥∞‡¥ï‡¥æ‡¥∂‡¥Ç ‡¥â‡¥±‡¥™‡µç‡¥™‡¥æ‡¥ï‡µç‡¥ï‡µÅ‡¥ï.', waterproofing: '‡¥µ‡¥æ‡¥ü‡µç‡¥ü‡µº‡¥™‡µç‡¥∞‡µÇ‡¥´‡¥ø‡¥Ç‡¥ó‡µç:', waterproofing_desc: '‡¥ö‡µã‡µº‡¥ö‡µç‡¥ö ‡¥§‡¥ü‡¥Ø‡µÅ‡¥®‡µç‡¥®‡¥§‡¥ø‡¥®‡µÅ‡¥≥‡µç‡¥≥ ‡¥í‡¥∞‡µÅ ‡¥®‡¥ø‡µº‡¥£‡¥æ‡¥Ø‡¥ï ‡¥Ü‡¥¶‡µç‡¥Ø‡¥™‡¥ü‡¥ø.', potting_mix: '‡¥™‡µã‡¥ü‡µç‡¥ü‡¥ø‡¥Ç‡¥ó‡µç ‡¥Æ‡¥ø‡¥∂‡µç‡¥∞‡¥ø‡¥§‡¥Ç:', potting_mix_desc: '‡¥Æ‡µá‡µΩ‡¥ï‡µç‡¥ï‡µÇ‡¥∞‡¥Ø‡µÅ‡¥ü‡µÜ ‡¥≠‡¥æ‡¥∞‡¥Ç ‡¥ï‡µÅ‡¥±‡¥Ø‡µç‡¥ï‡µç‡¥ï‡¥æ‡µª ‡¥≠‡¥æ‡¥∞‡¥Ç ‡¥ï‡µÅ‡¥±‡¥û‡µç‡¥û ‡¥Æ‡¥ø‡¥∂‡µç‡¥∞‡¥ø‡¥§‡¥Ç ‡¥â‡¥™‡¥Ø‡µã‡¥ó‡¥ø‡¥ï‡µç‡¥ï‡µÅ‡¥ï.', plant_selection: '‡¥ö‡µÜ‡¥ü‡¥ø ‡¥§‡¥ø‡¥∞‡¥û‡µç‡¥û‡µÜ‡¥ü‡µÅ‡¥ï‡µç‡¥ï‡µΩ:', plant_selection_desc: '‡¥§‡¥ï‡µç‡¥ï‡¥æ‡¥≥‡¥ø, ‡¥Æ‡µÅ‡¥≥‡¥ï‡µç, ‡¥™‡µÅ‡¥§‡¥ø‡¥® ‡¥§‡µÅ‡¥ü‡¥ô‡µç‡¥ô‡¥ø‡¥Ø ‡¥™‡¥ö‡µç‡¥ö‡¥ï‡µç‡¥ï‡¥±‡¥ø‡¥ï‡µæ ‡¥§‡¥ø‡¥∞‡¥û‡µç‡¥û‡µÜ‡¥ü‡µÅ‡¥ï‡µç‡¥ï‡µÅ‡¥ï.', pest_control: '‡¥ï‡µÄ‡¥ü ‡¥®‡¥ø‡¥Ø‡¥®‡µç‡¥§‡µç‡¥∞‡¥£‡¥Ç:', pest_control_desc: '‡¥µ‡µá‡¥™‡µç‡¥™‡µÜ‡¥£‡µç‡¥£ ‡¥™‡µã‡¥≤‡µÅ‡¥≥‡µç‡¥≥ ‡¥ú‡µà‡¥µ ‡¥∞‡µÄ‡¥§‡¥ø‡¥ï‡µæ ‡¥â‡¥™‡¥Ø‡µã‡¥ó‡¥ø‡¥ï‡µç‡¥ï‡µÅ‡¥ï.', contact_title: '‡¥∏‡¥π‡¥æ‡¥Ø‡¥Ç ‡¥µ‡µá‡¥£‡µã? ‡¥û‡¥ô‡µç‡¥ô‡¥≥‡µÜ ‡¥∏‡¥Æ‡µÄ‡¥™‡¥ø‡¥ï‡µç‡¥ï‡µÅ‡¥ï! üí¨', contact_desc: '‡¥è‡¥§‡µç ‡¥ï‡¥æ‡µº‡¥∑‡¥ø‡¥ï ‡¥∏‡¥Ç‡¥∂‡¥Ø‡¥ô‡µç‡¥ô‡µæ‡¥ï‡µç‡¥ï‡µÅ‡¥Ç ‡¥¨‡¥®‡µç‡¥ß‡¥™‡µç‡¥™‡µÜ‡¥ü‡µÅ‡¥ï!', toll_free: '‡¥ü‡µã‡µæ ‡¥´‡µç‡¥∞‡µÄ ‡¥®‡¥Æ‡µç‡¥™‡µº:', email: '‡¥á‡¥Æ‡µÜ‡¥Ø‡¥ø‡µΩ ‡¥µ‡¥ø‡¥≤‡¥æ‡¥∏‡¥Ç:', delete_options_title: '‡¥ì‡¥™‡µç‡¥∑‡¥®‡µÅ‡¥ï‡µæ ‡¥á‡¥≤‡µç‡¥≤‡¥æ‡¥§‡¥æ‡¥ï‡µç‡¥ï‡µÅ‡¥ï', delete_this_chat_button: '‡¥à ‡¥ö‡¥æ‡¥±‡µç‡¥±‡µç ‡¥á‡¥≤‡µç‡¥≤‡¥æ‡¥§‡¥æ‡¥ï‡µç‡¥ï‡µÅ‡¥ï', delete_all_chats_button: '‡¥é‡¥≤‡µç‡¥≤‡¥æ ‡¥ö‡¥æ‡¥±‡µç‡¥±‡µÅ‡¥ï‡¥≥‡µÅ‡¥Ç ‡¥á‡¥≤‡µç‡¥≤‡¥æ‡¥§‡¥æ‡¥ï‡µç‡¥ï‡µÅ‡¥ï', voice_listening: '‡¥ï‡µá‡µæ‡¥ï‡µç‡¥ï‡µÅ‡¥®‡µç‡¥®‡µÅ...', cancel_button: '‡¥∞‡¥¶‡µç‡¥¶‡¥æ‡¥ï‡µç‡¥ï‡µÅ‡¥ï', ok_button: '‡¥∂‡¥∞‡¥ø', choose_file: '‡¥´‡¥Ø‡µΩ ‡¥§‡¥ø‡¥∞‡¥û‡µç‡¥û‡µÜ‡¥ü‡µÅ‡¥ï‡µç‡¥ï‡µÅ‡¥ï', humidity: '‡¥à‡µº‡¥™‡µç‡¥™‡¥Ç', wind: '‡¥ï‡¥æ‡¥±‡µç‡¥±‡µç', lang_en: 'English', lang_ml: 'Malayalam', lang_hi: 'Hindi', lang_ta: 'Tamil' }
        };

        // --- DOM Elements ---
        const DOMElements = {
            chatHistory: document.getElementById('chat-history'), userInput: document.getElementById('user-input'), sendButton: document.getElementById('send-button'), voiceButton: document.getElementById('voice-button'), languageSelect: document.getElementById('language-select'), voiceSelect: document.getElementById('voice-select'), deleteChatButton: document.getElementById('delete-chat-button'), loadingModal: document.getElementById('loading-modal'), customModal: document.getElementById('custom-modal'), modalTitle: document.getElementById('modal-title'), modalMessage: document.getElementById('modal-message'), modalOkButton: document.getElementById('modal-ok-button'), modalCancelButton: document.getElementById('modal-cancel-button'), newChatButton: document.getElementById('new-chat-button'), recentChatsList: document.getElementById('recent-chats-list'), searchChatsInput: document.getElementById('search-chats'), menuToggle: document.getElementById('menu-toggle'), sidebar: document.getElementById('sidebar'), deleteOptionsModal: document.getElementById('delete-options-modal'), deleteThisChatOptionButton: document.getElementById('delete-this-chat-option-button'), deleteAllChatsOptionButton: document.getElementById('delete-all-chats-option-button'), deleteOptionsCancelButton: document.getElementById('delete-options-cancel-button'), uploadButton: document.getElementById('upload-button'), imageUpload: document.getElementById('image-upload'), timeDisplay: document.getElementById('time-display'), dateDisplay: document.getElementById('date-display'), voiceModal: document.getElementById('voice-modal'), stopVoiceButton: document.getElementById('stop-voice-button'), getLocationButton: document.getElementById('get-location-button'), fileNameDisplay: document.getElementById('file-name-display'),
            apiStatusButton: document.getElementById('api-status-button'), apiStatusIndicator: document.getElementById('api-status-indicator'), apiStatusText: document.getElementById('api-status-text'),
            locationDisplay: document.getElementById('location-display')
        };
        
        // --- UI Functions ---
        const showLoading = (show) => DOMElements.loadingModal.classList.toggle('hidden', !show);
        const showModal = (title, message, showCancelButton = false) => {
            const modalHeader = document.getElementById('modal-header');
            DOMElements.modalTitle.textContent = title;
            DOMElements.modalMessage.innerHTML = message; // Use innerHTML to allow links
            DOMElements.modalCancelButton.style.display = showCancelButton ? 'inline-block' : 'none';
            
            const isDeleteAction = modalAction && modalAction.toLowerCase().includes('delete');
            
            if (isDeleteAction) {
                modalHeader.style.background = 'linear-gradient(120deg, #b91c1c, #ef4444)';
                DOMElements.modalOkButton.style.background = 'linear-gradient(120deg, #b91c1c, #ef4444)';
            } else {
                modalHeader.style.background = 'linear-gradient(120deg, #1e40af, #3b82f6)';
                DOMElements.modalOkButton.style.background = 'linear-gradient(120deg, #1e40af, #3b82f6)';
            }
            DOMElements.customModal.classList.remove('hidden');
        };
        const updateLanguage = (lang) => {
            const langData = translations[lang] || translations['en-US'];
            document.querySelectorAll('[data-translate]').forEach(el => {
                el.textContent = langData[el.dataset.translate] || el.textContent
            });
            document.querySelectorAll('[data-translate-placeholder]').forEach(el => el.placeholder = langData[el.dataset.translatePlaceholder] || el.placeholder);
            localStorage.setItem('preferredLanguage', lang);
        };
        const parseMarkdown = (text) => {
            let html = text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>').replace(/### (.*)/g, '<h3>$1</h3>');
            const listItems = html.match(/^\* (.*)/gm);
            if (listItems) {
                html = html.replace(/^\* (.*)/gm, '') + '<ul>' + listItems.map(item => `<li>${item.substring(2)}</li>`).join('') + '</ul>';
            }
            return html.replace(/\n/g, '<br>');
        };
        const addMessageToChat = (text, sender, imageUrl = null) => {
            const messageEl = document.createElement('div');
            messageEl.classList.add('message-box', sender === 'user' ? 'user-message' : 'ai-message');
            messageEl.dataset.originalText = text; // Store original text for translation
            
            let content = sender === 'ai' ? parseMarkdown(text) : `<p>${text}</p>`;
            let controlsHTML = sender === 'ai' 
                ? `<div class="ai-message-controls">
                      <button class="control-button translate-button" title="Translate">
                         <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-600" viewBox="0 0 20 20" fill="currentColor">
                           <path fill-rule="evenodd" d="M7 2a1 1 0 011.707-.707l3.586 3.586a1 1 0 010 1.414l-3.586 3.586A1 1 0 017 9V5a1 1 0 00-1-1H3a1 1 0 000 2h2v4a1 1 0 001 1h2a1 1 0 100-2H7V2z" clip-rule="evenodd" />
                           <path d="M13 3a1 1 0 011 1v4a1 1 0 01-1 1h-2a1 1 0 110-2h1V4a1 1 0 01-1-1h-.5a1 1 0 010-2H13zM4 11a1 1 0 011-1h5a1 1 0 110 2H5a1 1 0 01-1-1zM11 13a1 1 0 011 1v1a1 1 0 11-2 0v-1a1 1 0 011-1zM14 11a1 1 0 100 2h1a1 1 0 100-2h-1z" />
                         </svg>
                      </button>
                      <button class="control-button speaker-button" data-text="${encodeURIComponent(text)}" title="Read aloud">
                         <svg class="play-icon h-5 w-5 text-gray-600" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path d="M6.3 2.841A1.5 1.5 0 004 4.11V15.89a1.5 1.5 0 002.3 1.269l9.344-5.89a1.5 1.5 0 000-2.538L6.3 2.84z"/></svg>
                         <svg class="stop-icon h-5 w-5 text-gray-600 hidden" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path d="M5 5h10v10H5V5z" /></svg>
                      </button>
                   </div>`
                : '';
            
            messageEl.innerHTML = `<strong>${sender === 'user' ? 'You' : 'Agri-Assistant'}:</strong><div class="message-content">${content}</div>${controlsHTML}`;

            if (imageUrl) {
                const imgEl = document.createElement('img');
                imgEl.src = imageUrl;
                imgEl.classList.add('mt-2', 'rounded-lg', 'max-w-full', 'h-auto', 'max-h-52');
                messageEl.querySelector('.message-content').appendChild(imgEl);
            }

            DOMElements.chatHistory.appendChild(messageEl);
            DOMElements.chatHistory.scrollTop = DOMElements.chatHistory.scrollHeight;
        };

        // --- Real-time Info & Weather ---
        const updateRealtimeInfo = () => {
            const now = new Date();
            const langCode = DOMElements.languageSelect.value;
            const timeOptions = { hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: true };
            const dateOptions = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
            
            try {
                 DOMElements.timeDisplay.textContent = new Intl.DateTimeFormat(langCode, timeOptions).format(now);
                 DOMElements.dateDisplay.textContent = new Intl.DateTimeFormat(langCode, dateOptions).format(now);
            } catch (e) {
                console.error("Could not format date/time for locale:", langCode, e);
                // Fallback to English for unsupported locales
                DOMElements.timeDisplay.textContent = new Intl.DateTimeFormat('en-US', timeOptions).format(now);
                DOMElements.dateDisplay.textContent = new Intl.DateTimeFormat('en-US', dateOptions).format(now);
            }
        };
        
        const updateWeatherUI = (data) => {
            if (!data || !data.description) return;
            document.getElementById('weather-container').classList.remove('hidden');
            DOMElements.locationDisplay.textContent = data.locationName || 'Current Location';
            document.getElementById('weather-icon').textContent = data.icon || 'üå°Ô∏è';
            document.getElementById('weather-desc').textContent = data.description;
            document.getElementById('temp-c-display').textContent = `${data.temperatureCelsius}¬∞C`;
            document.getElementById('temp-f-display').textContent = `${data.temperatureFahrenheit}¬∞F`;
            document.getElementById('humidity-display').textContent = data.humidity;
            document.getElementById('wind-display').textContent = data.windSpeed;
        };
        
        const fetchWeatherData = async (lat, lon) => {
            const prompt = `Based on the latest Google Weather data for latitude ${lat} and longitude ${lon}, provide ONLY a JSON object with the current weather. The JSON object must have these exact keys: "locationName" (string, e.g., "Mountain View, CA"), "description" (string, e.g., "Sunny"), "temperatureCelsius" (integer), "temperatureFahrenheit" (integer), "humidity" (integer), "windSpeed" (integer, in km/h), and "icon" (a single appropriate emoji, e.g., '‚òÄÔ∏è', '‚òÅÔ∏è', 'üåßÔ∏è'). Do not include any other text or markdown formatting.`;
            const payload = { contents: [{ parts: [{ text: prompt }] }] };
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent?key=${geminiApiKey}`;

            try {
                const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                if (!response.ok) throw new Error('Weather API fetch failed');
                const result = await response.json();
                let text = result?.candidates?.[0]?.content?.parts?.[0]?.text;
                text = text.replace(/```json/g, '').replace(/```/g, '').trim();
                const weatherData = JSON.parse(text);
                updateWeatherUI(weatherData);
            } catch (error) {
                console.error("Failed to fetch or parse weather data:", error);
                DOMElements.locationDisplay.textContent = "Weather unavailable";
            }
        };

        const getWeather = () => {
             if (navigator.geolocation) {
                 navigator.geolocation.getCurrentPosition(
                     async (position) => {
                         DOMElements.getLocationButton.classList.add('hidden');
                         await fetchWeatherData(position.coords.latitude, position.coords.longitude);
                     },
                     () => {
                         DOMElements.getLocationButton.classList.remove('hidden');
                         DOMElements.locationDisplay.textContent = "Location access needed";
                         console.log("User denied geolocation.");
                     }
                 );
             } else {
                 console.log("Geolocation is not supported by this browser.");
             }
        };

        // --- Chat Logic using LocalStorage ---
        const loadRecentChats = () => {
            const allChats = getAllChatsFromStorage();
            DOMElements.recentChatsList.innerHTML = '';
            
            const chatsArray = Object.entries(allChats).map(([id, chatData]) => ({ id, ...chatData }));
            chatsArray.sort((a, b) => b.timestamp - a.timestamp);

            chatsArray.forEach(chat => {
                const firstMessage = chat.history?.[0]?.text || 'New Chat';
                const chatEl = document.createElement('button');
                chatEl.className = 'w-full text-left p-2 rounded-lg hover:bg-blue-100 text-sm truncate transition-colors';
                chatEl.textContent = firstMessage;
                chatEl.dataset.chatId = chat.id;
                chatEl.addEventListener('click', () => loadChatHistory(chat.id));
                DOMElements.recentChatsList.appendChild(chatEl);
            });
        };
        const startNewChat = () => {
            currentChatId = null;
            localChatHistory = [];
            DOMElements.chatHistory.innerHTML = ''; 
            const lang = DOMElements.languageSelect.value || 'en-US';
            addMessageToChat(translations[lang].welcome_message, 'ai');
            document.querySelectorAll('#recent-chats-list button').forEach(btn => {
                btn.classList.remove('bg-blue-200', 'font-semibold');
            });
        };
        const loadChatHistory = (chatId) => {
            const allChats = getAllChatsFromStorage();
            if (allChats[chatId]) {
                currentChatId = chatId;
                localChatHistory = allChats[chatId].history || [];
                DOMElements.chatHistory.innerHTML = '';
                localChatHistory.forEach(msg => addMessageToChat(msg.text, msg.sender, msg.imageUrl));
                document.querySelectorAll('#recent-chats-list button').forEach(btn => {
                    btn.classList.toggle('bg-blue-200', btn.dataset.chatId === chatId);
                    btn.classList.toggle('font-semibold', btn.dataset.chatId === chatId);
                });
            } else {
                console.error("Chat document does not exist!");
                startNewChat();
            }
        };
        const saveChatHistory = () => {
            if (localChatHistory.length === 0) return;
            const allChats = getAllChatsFromStorage();

            if (!currentChatId) {
                currentChatId = `chat_${Date.now()}`;
            }
            
            allChats[currentChatId] = {
                history: localChatHistory,
                timestamp: Date.now()
            };
            
            saveAllChatsToStorage(allChats);
            loadRecentChats(); // Refresh the sidebar
            document.querySelectorAll('#recent-chats-list button').forEach(btn => {
                 btn.classList.toggle('bg-blue-200', btn.dataset.chatId === currentChatId);
                 btn.classList.toggle('font-semibold', btn.dataset.chatId === currentChatId);
            });
        };

        const deleteThisChat = () => {
            if (!currentChatId) {
                showModal("Error", "No active chat selected to delete.");
                return;
            }
            const allChats = getAllChatsFromStorage();
            delete allChats[currentChatId];
            saveAllChatsToStorage(allChats);
            loadRecentChats();
            startNewChat();
        };
        
        const deleteSpecificChat = (chatId) => {
            if (!chatId) {
                showModal("Error", "Chat ID not found for deletion.");
                return;
            }
            showLoading(true);
            const allChats = getAllChatsFromStorage();
            delete allChats[chatId];
            saveAllChatsToStorage(allChats);
            
            if (currentChatId === chatId) {
                startNewChat();
            }
            loadRecentChats();
            showLoading(false);
        };

        const deleteAllChats = () => {
            saveAllChatsToStorage({});
            loadRecentChats();
            startNewChat();
        };

        const handleApiError = async (response) => {
            const errorData = await response.json();
            const errorMessage = errorData.error?.message || 'An unknown error occurred.';
            DOMElements.apiStatusIndicator.classList.remove('bg-yellow-500', 'animate-pulse', 'bg-green-500');
            DOMElements.apiStatusIndicator.classList.add('bg-red-500');
            DOMElements.apiStatusText.textContent = 'API Error';

            if (response.status === 429 || errorMessage.toLowerCase().includes('quota') || errorMessage.toLowerCase().includes('billing')) {
                 showModal(
                    "Billing & Quota Issue",
                    `Your Google Cloud project's billing account is not configured correctly, or you have exceeded the API usage quota. Please verify that your project is linked to an active billing account.<br><br><a href="https://console.cloud.google.com/billing" target="_blank" class="text-blue-600 underline font-bold">Fix Billing & Manage Quotas</a>`,
                    false
                );
            } else {
                showModal("API Error", `An error occurred: ${errorMessage} <br><br> <a href="https://cloud.google.com/vertex-ai/docs/generative-ai/model-reference/gemini" target="_blank" class="text-blue-600 underline">Learn More</a>`);
            }
        };

        // --- Core API Call Logic ---
        const handleTextQuery = async (query) => {
            if (!query.trim()) return;
            
            addMessageToChat(query, 'user');
            localChatHistory.push({ text: query, sender: 'user'});
            saveChatHistory();
            showLoading(true);
            
            const selectedLanguage = DOMElements.languageSelect.options[DOMElements.languageSelect.selectedIndex].text;

            const geminiPayload = localChatHistory.map(msg => ({
                role: msg.sender === 'user' ? 'user' : 'model',
                parts: [{ text: msg.text }]
            }));
            
            const systemPrompt = `You are Friday, a specialized AI Agri-Assistant. 
**PRIMARY DIRECTIVE:** You ONLY answer questions related to agriculture. This includes topics like weather patterns, crop cycles, seed varieties, organic and chemical pesticides, land area calculations (acres, hectares), pond water management, irrigation techniques (drip, sprinkler, etc.), soil health, terrace farming, and general land farming.
- If the user asks a non-agricultural question, you MUST respond with: "I can only assist with agriculture-related queries. How can I help you with your farming needs today?"
**LANGUAGE HANDLING:**
- The user has selected their preferred language as **${selectedLanguage}**. 
- You MUST provide your entire response in **${selectedLanguage}**, regardless of the language of the user's query.
**RESPONSE GUIDELINES:**
- **Accuracy:** Provide specific, accurate information for any recommendations.
- **Pesticide Safety:** When recommending pesticides, ALWAYS include active ingredients, dosage, and safety warnings.
- **Formatting:** Use Markdown for clarity ('### Title', '* ' for bullets, '**bold**').
- **Practicality:** Give actionable, step-by-step advice.
- **Engage:** Conclude with a relevant follow-up question in ${selectedLanguage}.`;

            const payload = { 
                contents: geminiPayload, 
                tools: [{ "google_search_retrieval": {} }],
                systemInstruction: { parts: [{ text: systemPrompt }] } 
            };
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent?key=${geminiApiKey}`;

            try {
                const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                if (!response.ok) {
                    await handleApiError(response);
                    return;
                }
                const result = await response.json();
                const text = result?.candidates?.[0]?.content?.parts?.[0]?.text;
                if (text) {
                    addMessageToChat(text, 'ai');
                    localChatHistory.push({ text: text, sender: 'ai' });
                    saveChatHistory();
                    if (isVoiceInteraction) {
                        speakText(text, null);
                        isVoiceInteraction = false;
                    }
                } else { addMessageToChat("Sorry, I couldn't get a response.", 'ai'); }
            } catch (error) { showModal("Error", `Failed to get a response: ${error.message}`); } 
            finally { showLoading(false); }
        };

        const handleImageAnalysis = async (base64ImageData) => { 
            showLoading(true);
            const prompt = `Analyze this agricultural image. Identify any visible plant diseases, pests, or nutrient deficiencies. If a problem is identified, suggest organic and chemical pesticide recommendations with dosages. If it's not an agricultural image, state that you can only analyze farming-related pictures. Respond in the language of the user's UI, which is set to ${DOMElements.languageSelect.options[DOMElements.languageSelect.selectedIndex].text}.`;
            addMessageToChat("Analyzing your image...", 'user', base64ImageData);
            localChatHistory.push({ text: "Analyzing your image...", sender: 'user', imageUrl: base64ImageData });

            const payload = {
                contents: [{ parts: [{ text: prompt }, { inlineData: { mimeType: "image/jpeg", data: base64ImageData.split(',')[1] } }] }]
            };
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent?key=${geminiApiKey}`;

            try {
                const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                if (!response.ok) {
                    await handleApiError(response);
                    return;
                }
                const result = await response.json();
                const text = result?.candidates?.[0]?.content?.parts?.[0]?.text;
                 if (text) {
                    addMessageToChat(text, 'ai');
                    localChatHistory.push({ text: text, sender: 'ai' });
                    await saveChatHistory();
                 } else { addMessageToChat("Sorry, I could not analyze the image.", 'ai'); }
            } catch (error) { showModal("Error", `Image analysis failed: ${error.message}`); }
            finally { showLoading(false); }
           };

        const checkApiStatus = async () => {
            DOMElements.apiStatusIndicator.classList.remove('bg-green-500', 'bg-red-500');
            DOMElements.apiStatusIndicator.classList.add('bg-yellow-500', 'animate-pulse');
            DOMElements.apiStatusText.textContent = 'Checking API...';

            // A simple, low-cost API call to check for authentication and billing.
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models?key=${geminiApiKey}`;
            try {
                const response = await fetch(apiUrl);
                if (response.ok) {
                    DOMElements.apiStatusIndicator.classList.remove('bg-yellow-500', 'animate-pulse', 'bg-red-500');
                    DOMElements.apiStatusIndicator.classList.add('bg-green-500');
                    DOMElements.apiStatusText.textContent = 'API Connected';
                } else {
                    await handleApiError(response);
                }
            } catch (error) {
                DOMElements.apiStatusIndicator.classList.remove('bg-yellow-500', 'animate-pulse', 'bg-green-500');
                DOMElements.apiStatusIndicator.classList.add('bg-red-500');
                DOMElements.apiStatusText.textContent = 'API Error';
                showModal('Network Error', `Could not connect to the API. Check your internet connection.`);
            }
        };
        
        // --- Voice Synthesis and Recognition ---
        const recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
        recognition.interimResults = false;
        recognition.addEventListener('result', e => {
            DOMElements.voiceModal.classList.add('hidden');
            handleTextQuery(e.results[0][0].transcript);
        });
        recognition.addEventListener('end', () => DOMElements.voiceModal.classList.add('hidden'));
        recognition.addEventListener('error', (e) => showModal('Voice Error', `Recognition error: ${e.error}`));
        
        const loadVoices = () => {
            speechVoices = speechSynthesis.getVoices();
            DOMElements.voiceSelect.innerHTML = '';
            
            const funkyNames = ['Nova', 'Orion', 'Lyra', 'Cove', 'Juno', 'Echo', 'Breeze', 'Axel', 'Vega', 'Zion'];
            let nameIndex = 0;

            speechVoices
                .filter(voice => voice.lang.startsWith('en') || voice.lang.startsWith('hi') || voice.lang.startsWith('ta') || voice.lang.startsWith('ml'))
                .forEach(voice => {
                    const option = document.createElement('option');
                    option.textContent = `${funkyNames[nameIndex % funkyNames.length]} (${voice.lang})`;
                    option.value = voice.name;
                    DOMElements.voiceSelect.appendChild(option);
                    nameIndex++;
                });
        };

        const speakText = (text, button) => {
            if (speechSynthesis.speaking) {
                speechSynthesis.cancel();
                if (currentUtterance && currentUtterance.text === text) {
                    currentUtterance = null;
                    return;
                }
            }
            
            currentUtterance = new SpeechSynthesisUtterance(text);
            
            let lang = 'en-US'; // Default
            if (/[\u0900-\u097F]/.test(text)) lang = 'hi-IN'; // Devanagari characters for Hindi
            else if (/[\u0d00-\u0d7F]/.test(text)) lang = 'ml-IN'; // Malayalam characters
            else if (/[\u0b80-\u0bff]/.test(text)) lang = 'ta-IN'; // Tamil characters
            
            currentUtterance.lang = lang;
            
            const selectedVoiceName = DOMElements.voiceSelect.value;
            const voice = speechVoices.find(v => v.name === selectedVoiceName);

            if (voice) {
                currentUtterance.voice = voice;
            } else {
                 console.warn(`No specific voice found for language: ${lang}. Using browser default.`);
            }
            
            document.querySelectorAll('.play-icon').forEach(i => i.classList.remove('hidden'));
            document.querySelectorAll('.stop-icon').forEach(i => i.classList.add('hidden'));

            if(button) {
                const playIcon = button.querySelector('.play-icon');
                const stopIcon = button.querySelector('.stop-icon');
                currentUtterance.onstart = () => { playIcon.classList.add('hidden'); stopIcon.classList.remove('hidden'); };
                currentUtterance.onend = () => { playIcon.classList.remove('hidden'); stopIcon.classList.add('hidden'); currentUtterance = null; };
                currentUtterance.onerror = (e) => { 
                    console.error("Speech synthesis error:", e);
                    playIcon.classList.remove('hidden'); stopIcon.classList.add('hidden'); currentUtterance = null; 
                };
            } else {
                 currentUtterance.onend = () => { currentUtterance = null; };
                 currentUtterance.onerror = (e) => { 
                    console.error("Speech synthesis error:", e);
                    currentUtterance = null; 
                 };
            }
            speechSynthesis.speak(currentUtterance);
        };

        // --- In-Chat Translation ---
        const translateMessage = async (messageEl, targetLangCode, targetLangName) => {
            showLoading(true);
            const originalText = messageEl.dataset.originalText;
            const prompt = `Translate the following text to ${targetLangName}. Provide ONLY the translation, with no extra commentary or explanations:\n\n"${originalText}"`;
            
            const payload = { contents: [{ parts: [{ text: prompt }] }] };
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent?key=${geminiApiKey}`;

            try {
                const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                if (!response.ok) throw new Error('Translation API call failed');

                const result = await response.json();
                const translatedText = result?.candidates?.[0]?.content?.parts?.[0]?.text;

                if (translatedText) {
                    const contentDiv = messageEl.querySelector('.message-content');
                    const speakerButton = messageEl.querySelector('.speaker-button');
                    contentDiv.innerHTML = parseMarkdown(translatedText);
                    if (speakerButton) {
                        speakerButton.dataset.text = encodeURIComponent(translatedText);
                    }
                } else {
                    showModal("Translation Error", "Could not translate the message.");
                }
            } catch (error) {
                console.error("Translation failed:", error);
                showModal("Translation Error", `Failed to translate: ${error.message}`);
            } finally {
                showLoading(false);
            }
        };

        const showLanguageSelector = (button) => {
            // Close any existing popups
            document.querySelectorAll('.translate-popup').forEach(p => p.remove());

            const messageEl = button.closest('.message-box');
            const popup = document.createElement('div');
            popup.className = 'translate-popup';

            const languages = [
                { code: 'en-US', name: 'English' },
                { code: 'ta-IN', name: 'Tamil' },
                { code: 'hi-IN', name: 'Hindi' },
                { code: 'ml-IN', name: 'Malayalam' },
            ];

            languages.forEach(lang => {
                const langButton = document.createElement('button');
                langButton.textContent = lang.name;
                langButton.onclick = () => {
                    translateMessage(messageEl, lang.code, lang.name);
                    popup.remove();
                };
                popup.appendChild(langButton);
            });

            messageEl.appendChild(popup);

            // Add event listener to close popup when clicking outside
            setTimeout(() => {
                document.addEventListener('click', (e) => {
                    if (!popup.contains(e.target) && e.target !== button) {
                        popup.remove();
                    }
                }, { once: true });
            }, 0);
        };

        // --- Event Listeners ---
        DOMElements.sendButton.addEventListener('click', () => { handleTextQuery(DOMElements.userInput.value); DOMElements.userInput.value = ''; });
        DOMElements.userInput.addEventListener('keypress', (e) => e.key === 'Enter' && DOMElements.sendButton.click());
        DOMElements.apiStatusButton.addEventListener('click', checkApiStatus);
        DOMElements.imageUpload.addEventListener('change', () => {
            const file = DOMElements.imageUpload.files[0];
            DOMElements.fileNameDisplay.textContent = file ? file.name : '';
        });
        DOMElements.uploadButton.addEventListener('click', () => { 
            const file = DOMElements.imageUpload.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => handleImageAnalysis(e.target.result);
                reader.readAsDataURL(file);
                 DOMElements.imageUpload.value = ''; // Reset file input
                 DOMElements.fileNameDisplay.textContent = ''; // Clear file name display
            } else {
                showModal("No File Selected", "Please choose an image file to analyze.");
            }
        });
        DOMElements.deleteChatButton.addEventListener('click', () => DOMElements.deleteOptionsModal.classList.remove('hidden'));
        DOMElements.deleteOptionsCancelButton.addEventListener('click', () => DOMElements.deleteOptionsModal.classList.add('hidden'));
        DOMElements.deleteThisChatOptionButton.addEventListener('click', () => {
            DOMElements.deleteOptionsModal.classList.add('hidden');
            modalAction = 'deleteThisChat';
            showModal('Confirm Deletion', 'Are you sure you want to delete this chat?', true);
        });
        DOMElements.deleteAllChatsOptionButton.addEventListener('click', () => {
             DOMElements.deleteOptionsModal.classList.add('hidden');
            modalAction = 'deleteAllChats';
            showModal('Confirm Deletion', 'Are you sure you want to delete ALL chats?', true);
        });
        DOMElements.voiceButton.addEventListener('click', () => {
            isVoiceInteraction = true;
            recognition.lang = DOMElements.languageSelect.value;
            DOMElements.voiceModal.classList.remove('hidden');
            DOMElements.voiceModal.classList.add('flex');
            recognition.start();
        });
        DOMElements.stopVoiceButton.addEventListener('click', () => recognition.stop());
        DOMElements.modalOkButton.addEventListener('click', async () => {
            DOMElements.customModal.classList.add('hidden');
            if (modalAction === 'deleteThisChat') await deleteThisChat();
            if (modalAction === 'deleteAllChats') await deleteAllChats();
            if (modalAction === 'deleteSpecificChat') {
                const chatId = DOMElements.modalOkButton.dataset.chatIdToDelete;
                if (chatId) await deleteSpecificChat(chatId);
            }
            modalAction = null;
            delete DOMElements.modalOkButton.dataset.chatIdToDelete;
        });
        DOMElements.modalCancelButton.addEventListener('click', () => DOMElements.customModal.classList.add('hidden'));
        DOMElements.newChatButton.addEventListener('click', startNewChat);
        DOMElements.menuToggle.addEventListener('click', () => DOMElements.sidebar.classList.toggle('-translate-x-full'));
        DOMElements.languageSelect.addEventListener('change', (e) => {
            updateLanguage(e.target.value);
            updateRealtimeInfo();
            startNewChat(); // Reset chat when language is changed via dropdown
        });
        DOMElements.chatHistory.addEventListener('click', (e) => {
            const speakerButton = e.target.closest('.speaker-button');
            if (speakerButton) {
                speakText(decodeURIComponent(speakerButton.dataset.text), speakerButton);
                return;
            }
            const translateButton = e.target.closest('.translate-button');
            if (translateButton) {
                showLanguageSelector(translateButton);
            }
        });
        DOMElements.recentChatsList.addEventListener('contextmenu', (e) => {
            e.preventDefault();
            const chatButton = e.target.closest('button[data-chat-id]');
            if (chatButton) {
                const chatIdToDelete = chatButton.dataset.chatId;
                modalAction = 'deleteSpecificChat';
                DOMElements.modalOkButton.dataset.chatIdToDelete = chatIdToDelete;
                showModal('Confirm Deletion', `Are you sure you want to delete this chat?`, true);
            }
        });
        DOMElements.getLocationButton.addEventListener('click', getWeather);


        // --- Initial Page Load ---
        userId = getUserId();
        document.getElementById('user-id').textContent = `User ID: ${userId}`;
        
        const savedLang = localStorage.getItem('preferredLanguage') || 'en-US';
        DOMElements.languageSelect.value = savedLang;
        updateLanguage(savedLang);
        updateRealtimeInfo();
        setInterval(updateRealtimeInfo, 1000);
        
        // Load speech synthesis voices, which can be asynchronous
        loadVoices();
        if (speechSynthesis.onvoiceschanged !== undefined) {
            speechSynthesis.onvoiceschanged = loadVoices;
        }
        
        getWeather(); // Attempt to get weather on load
        loadRecentChats();
        startNewChat();
        checkApiStatus(); // Check API status on page load

    </script>
</body>
</html>
