<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Agri-Assistant</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #e0f2fe, #f0fdf4, #fefce8);
            color: #1e3a8a; /* A darker blue for better contrast */
        }
        .main-container {
            max-width: 1400px;
            height: calc(100vh - 2rem);
        }
        .chat-container {
            background-color: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(10px);
            border-radius: 1.5rem; /* More rounded */
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.15);
            display: flex;
            flex-direction: column;
            height: 100%;
        }
        .message-box {
            padding: 0.75rem 1.25rem;
            margin-bottom: 0.75rem;
            max-width: 80%;
            word-wrap: break-word;
            position: relative;
            border-radius: 1rem;
            animation: message-fade-in 0.4s ease-out forwards;
            opacity: 0;
            transform: translateY(10px);
        }
        
        @keyframes message-fade-in {
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .user-message {
            background: linear-gradient(120deg, #3b82f6, #60a5fa);
            color: #ffffff;
            align-self: flex-end;
            border-bottom-right-radius: 0.25rem;
            box-shadow: 0 2px 4px rgba(59, 130, 246, 0.2);
        }
        .ai-message {
            background-color: #ffffff;
            color: #374151;
            align-self: flex-start;
            border: 1px solid #e5e7eb;
            border-bottom-left-radius: 0.25rem;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }
        .ai-message h3 { font-size: 1.1rem; font-weight: bold; margin-bottom: 0.5rem; color: #1d4ed8; }
        .ai-message ul { list-style-type: '🌿'; padding-left: 1.5rem; margin-top: 0.5rem; }
        .ai-message li { margin-bottom: 0.25rem; padding-left: 0.5rem; }
        .message-box strong { display: block; font-size: 0.8rem; color: rgba(255,255,255,0.8); }
        .ai-message strong { color: #4b5563; }

        .btn-primary, .btn-secondary {
            transition: all 0.3s ease;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .btn-primary:hover, .btn-secondary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.15);
        }

        #loading-spinner {
            border: 5px solid #f3f4f6; border-top: 5px solid #2563eb;
            border-radius: 50%; width: 50px; height: 50px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        #sidebar { 
            transition: transform 0.3s ease-in-out; 
            background-color: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(5px);
            border-right: 1px solid rgba(255, 255, 255, 0.3);
        }
        .speaker-button {
            position: absolute; bottom: 8px; right: 8px; background: #e5e7eb;
            border-radius: 50%; width: 28px; height: 28px;
            display: flex; align-items: center; justify-content: center;
            cursor: pointer; border: none;
            transition: background-color 0.2s;
        }
        .speaker-button:hover { background-color: #d1d5db; }
        
        #voice-modal { background-color: rgba(0, 0, 0, 0.85); backdrop-filter: blur(5px); }
        .voice-wave {
            width: 80px; height: 80px; border-radius: 50%;
            background: conic-gradient(#3b82f6 0%, #a855f7 50%, #3b82f6 100%);
            animation: wave 1.5s linear infinite, pulse 2s infinite ease-in-out;
            position: relative;
            display: flex; justify-content: center; align-items: center;
        }
        .voice-wave-inner {
            width: 65px; height: 65px; border-radius: 50%;
            background-color: #1e3a8a;
        }
        @keyframes wave {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }
        #stop-voice-button {
            background-color: #ef4444; color: white;
            width: 60px; height: 60px; border-radius: 50%;
            display: flex; justify-content: center; align-items: center;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
            transition: background-color 0.2s, transform 0.2s;
        }
        #stop-voice-button:hover { background-color: #dc2626; transform: scale(1.1); }
        .info-card {
            background-color: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.1);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        .info-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 36px 0 rgba(31, 38, 135, 0.15);
        }
        .info-card h3 {
            background: linear-gradient(120deg, #1e3a8a, #2563eb);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
    </style>
</head>
<body class="p-4">
    <div class="main-container mx-auto flex gap-4">

        <aside id="sidebar" class="p-4 rounded-2xl flex-col w-64 absolute md:relative z-20 md:transform-none -translate-x-full">
            <button id="new-chat-button" class="w-full text-left p-3 mb-4 rounded-xl hover:bg-blue-100 font-semibold flex items-center gap-3 text-gray-700 transition-colors">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-blue-600" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd" /></svg>
                <span data-translate="new_chat">New Chat</span>
            </button>
            <div class="relative mb-4">
                <input type="text" id="search-chats" data-translate-placeholder="search_placeholder" placeholder="Search..." class="w-full p-2 border rounded-lg text-sm pl-8 focus:ring-2 focus:ring-blue-400 transition">
                <svg class="w-4 h-4 absolute top-1/2 left-2.5 -translate-y-1/2 text-gray-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
            </div>
            <h3 data-translate="recent" class="text-sm font-bold text-gray-500 uppercase px-2 mb-2">Recent</h3>
            <div id="recent-chats-list" class="flex-1 overflow-y-auto space-y-1"></div>
        </aside>

        <main class="flex-1 flex flex-col md:flex-row gap-4">
            <button id="menu-toggle" class="md:hidden absolute top-4 left-4 z-30 p-2 bg-white rounded-full shadow-md">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" /></svg>
            </button>

            <div class="flex-1 flex flex-col gap-4">
                <div class="text-center md:text-left">
                    <h1 class="text-4xl font-bold" data-translate="title" style="background: linear-gradient(120deg, #1e3a8a, #2563eb, #3b82f6); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">Agri-Assistant</h1>
                    <p id="user-id" class="text-sm font-medium mt-2 text-gray-500">Connecting...</p>
                </div>
                <div class="chat-container flex flex-col p-4 flex-1 overflow-hidden">
                    <div id="chat-history" class="flex-1 overflow-y-auto pr-4 mb-4 space-y-4"></div>
                    <div class="flex items-center space-x-2 border-t pt-4 mt-auto">
                        <select id="language-select" class="p-2 border rounded-lg text-sm bg-gray-50 focus:ring-2 focus:ring-blue-400 transition">
                            <option value="en-US" data-translate="lang_en">English</option>
                            <option value="ml-IN" data-translate="lang_ml">Malayalam</option>
                            <option value="hi-IN" data-translate="lang_hi">Hindi</option>
                            <option value="ta-IN" data-translate="lang_ta">Tamil</option>
                        </select>
                        <input type="text" id="user-input" data-translate-placeholder="type_query_placeholder" placeholder="Type your query..." class="flex-1 p-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition">
                        <button id="voice-button" class="p-3 rounded-full hover:bg-blue-100 transition-colors">
                           <svg class="mic-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" style="width: 24px; height: 24px; fill: #1e40af;"><path d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3zm5.5-3c0 3.53-2.64 6.44-6.07 6.94V21h-2.87v-3.06c-3.43-.5-6.07-3.41-6.07-6.94h2c0 2.91 2.37 5.26 5.29 5.26S15.5 13.91 15.5 11h2z"/></svg>
                        </button>
                        <button id="send-button" class="btn-primary" style="background: linear-gradient(120deg, #1e40af, #3b82f6); color: #ffffff; padding: 0.75rem 1.5rem; border-radius: 0.75rem;" data-translate="send_button">Send</button>
                    </div>
                    <div class="mt-4 flex flex-col md:flex-row items-center gap-4">
                        <div class="w-full flex items-center gap-2">
                            <label for="image-upload" id="image-upload-label" data-translate="choose_file" class="cursor-pointer text-sm text-blue-700 font-semibold bg-blue-100 hover:bg-blue-200 text-center p-2 rounded-lg whitespace-nowrap transition-colors">Choose file</label>
                            <input type="file" id="image-upload" accept="image/*" class="hidden" />
                            <span id="file-name-display" class="text-sm text-gray-600 truncate"></span>
                        </div>
                        <button id="upload-button" class="btn-primary w-full md:w-auto" style="background: linear-gradient(120deg, #166534, #22c55e); color: #ffffff; padding: 0.5rem 1rem; border-radius: 0.5rem;" data-translate="analyze_image_button">Analyze Image</button>
                        <button id="delete-chat-button" class="btn-primary w-full md:w-auto" style="background: linear-gradient(120deg, #b91c1c, #ef4444); color: #ffffff; padding: 0.5rem 1rem; border-radius: 0.5rem;" data-translate="delete_chat_button">Delete Chat</button>
                    </div>
                </div>
            </div>
            <div class="w-full md:w-1/3 flex flex-col gap-4">
                <div class="info-card bg-white p-4 rounded-2xl text-center">
                    <p id="time-display" class="font-bold text-3xl text-blue-800"></p>
                    <p id="date-display" class="text-sm text-gray-600"></p>
                    <div id="weather-container" class="mt-4 pt-4 border-t border-gray-200 hidden">
                        <div class="flex justify-around items-center text-gray-700">
                            <div class="text-center">
                                <div id="weather-icon" class="text-4xl animate-pulse"></div>
                                <p id="weather-desc" class="text-sm font-medium"></p>
                            </div>
                            <div class="space-y-1 text-sm text-left">
                                <p>💧 <strong data-translate="humidity">Humidity:</strong> <span id="humidity-display">--</span>%</p>
                                <p>💨 <strong data-translate="wind">Wind:</strong> <span id="wind-display">--</span> km/h</p>
                            </div>
                        </div>
                         <button id="get-location-button" class="mt-3 text-xs text-blue-600 hover:underline hidden">Allow location access for weather</button>
                    </div>
                </div>

                <div class="info-card p-6 rounded-2xl flex flex-col items-center">
                    <h3 class="text-xl font-bold mb-2 text-center" data-translate="terrace_guide_title">Terrace Farming Guide</h3>
                    <p class="text-sm text-gray-700 mb-4 text-center" data-translate="terrace_guide_desc">Discover how to create your own lush garden on a rooftop or balcony.</p>
                    <ul class="text-sm list-disc pl-5 mt-4 text-gray-800 space-y-2">
                        <li><strong data-translate="sunlight">Sunlight:</strong> <span data-translate="sunlight_desc">Ensure your terrace receives at least 5-6 hours of direct sunlight.</span></li>
                        <li><strong data-translate="waterproofing">Waterproofing:</strong> <span data-translate="waterproofing_desc">A critical first step to prevent leaks.</span></li>
                        <li><strong data-translate="potting_mix">Potting Mix:</strong> <span data-translate="potting_mix_desc">Use a lightweight mix to reduce the load on your roof.</span></li>
                        <li><strong data-translate="plant_selection">Plant Selection:</strong> <span data-translate="plant_selection_desc">Choose vegetables like tomatoes, chili, mint, and spinach.</span></li>
                        <li><strong data-translate="pest_control">Pest Control:</strong> <span data-translate="pest_control_desc">Use organic methods like neem oil.</span></li>
                    </ul>
                </div>
                <div class="info-card p-6 rounded-2xl flex flex-col items-center">
                    <h3 class="text-xl font-bold mb-2 text-center" data-translate="contact_title">Need Help? Contact Us! 💬</h3>
                    <p class="text-sm text-gray-700 mb-4 text-center" data-translate="contact_desc">For any agricultural queries or support, reach out to us!</p>
                    <ul class="text-sm list-disc pl-5 mt-4 text-gray-800 space-y-2">
                        <li><strong data-translate="toll_free">Toll-Free Number:</strong> 1-800-123-4567</li>
                        <li><strong data-translate="email">Email Address:</strong> support@agri-assistant.com</li>
                    </ul>
                </div>
            </div>
        </main>
    </div>

    <!-- Modals -->
    <div id="loading-modal" class="fixed inset-0 bg-gray-900 bg-opacity-50 flex justify-center items-center hidden z-50"><div id="loading-spinner"></div></div>
    <div id="custom-modal" class="fixed inset-0 bg-gray-900 bg-opacity-50 flex justify-center items-center hidden z-50 p-4">
        <div class="bg-white rounded-lg shadow-xl max-w-sm w-full overflow-hidden transform transition-all animate-fade-in">
            <div id="modal-header" class="p-4">
                 <h3 id="modal-title" class="text-xl font-bold text-white text-center"></h3>
            </div>
            <div class="p-6 text-center">
                <p id="modal-message" class="text-gray-700 mb-6"></p>
                <div class="flex justify-center gap-4">
                    <button id="modal-cancel-button" class="px-6 py-2 rounded-lg bg-gray-200 text-gray-800 hover:bg-gray-300 font-semibold transition-colors">Cancel</button>
                    <button id="modal-ok-button" class="px-6 py-2 rounded-lg text-white font-semibold transition-colors btn-primary">OK</button>
                </div>
            </div>
        </div>
    </div>
    <div id="delete-options-modal" class="fixed inset-0 bg-gray-900 bg-opacity-50 flex justify-center items-center hidden z-50 p-4">
        <div class="bg-white p-6 rounded-lg shadow-xl max-w-sm w-full text-center transform transition-all animate-fade-in">
            <h3 data-translate="delete_options_title" class="text-xl font-bold mb-4">Delete Options</h3>
            <div class="flex flex-col gap-4">
                <button id="delete-this-chat-option-button" data-translate="delete_this_chat_button" class="w-full btn-primary" style="background-color: #1e40af; color: #ffffff; padding: 0.5rem 1rem; border-radius: 0.5rem;">Delete This Chat</button>
                <button id="delete-all-chats-option-button" data-translate="delete_all_chats_button" class="w-full btn-primary" style="background-color: #dc2626; color: #ffffff; padding: 0.5rem 1rem; border-radius: 0.5rem;">Delete All Chats</button>
                <button id="delete-options-cancel-button" data-translate="cancel_button" class="w-full btn-secondary mt-2" style="background-color: #f3f4f6; color: #1f2937; padding: 0.5rem 1rem; border-radius: 0.5rem;">Cancel</button>
            </div>
        </div>
    </div>
    <div id="voice-modal" class="fixed inset-0 justify-center items-center hidden z-50">
        <div class="w-full h-full flex flex-col justify-center items-center relative gap-8">
            <div class="voice-wave"><div class="voice-wave-inner"></div></div>
            <p data-translate="voice_listening" class="text-white text-2xl">Listening...</p>
            <button id="stop-voice-button">
                 <svg class="w-8 h-8" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M6 6h12v12H6z"/></svg>
            </button>
        </div>
    </div>


    <script type="module">
        import { initializeApp, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, onSnapshot, setDoc, addDoc, deleteDoc, collection, query, serverTimestamp, getDocs, writeBatch } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        setLogLevel('debug');

        // --- Environment-provided Keys ---
        // FIX: Use environment variables for Firebase config and leave Gemini API key blank for injection.
        const firebaseConfig = {
  apiKey: "AIzaSyAgxfqvcE26u5bOOS7snmbKMe1zHoDjp24",
  authDomain: "agri-ai-friday-d3e1a.firebaseapp.com",
  projectId: "agri-ai-friday-d3e1a",
  storageBucket: "agri-ai-friday-d3e1a.firebasestorage.app",
  messagingSenderId: "967822044561",
  appId: "1:967822044561:web:3d25728aebea646d547e30",
  measurementId: "G-YTPW970P8C"
};

        const geminiApiKey = "AIzaSyC6LbnlfJPd23wiMHM1JMEP2I3_rteUJOM";

        // --- Global Variables ---
        let db, auth, userId, currentChatId = null, chatHistoryUnsubscribe = null, modalAction = null;
        let localChatHistory = [];
        let currentUtterance = null;
        let isVoiceInteraction = false;

        // --- Firebase Initialization ---
        try {
            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
            onAuthStateChanged(auth, async (user) => {
                if (chatHistoryUnsubscribe) chatHistoryUnsubscribe();
                if (user) {
                    userId = user.uid;
                    document.getElementById('user-id').textContent = `User ID: ${userId}`;
                    await loadRecentChats();
                    startNewChat(); 
                } else {
                    document.getElementById('user-id').textContent = "Authenticating...";
                    if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                         await signInWithCustomToken(auth, __initial_auth_token);
                    } else {
                         await signInAnonymously(auth);
                    }
                }
            });
        } catch (error) {
            console.error("Firebase initialization failed:", error);
            showModal("Error", "Initialization failed. Please check configuration.");
        }

        // --- Translation Data (unchanged) ---
        const translations = {
            'en-US': { title: 'Agri-Assistant', new_chat: 'New Chat', search_placeholder: 'Search...', recent: 'Recent', welcome_message: "Welcome! How can I assist?", type_query_placeholder: 'Type your query...', send_button: 'Send', analyze_image_button: 'Analyze Image', delete_chat_button: 'Delete Chat', terrace_guide_title: 'Terrace Farming Guide', terrace_guide_desc: 'Create your own lush garden on a rooftop.', sunlight: 'Sunlight:', sunlight_desc: 'Ensure 5-6 hours of direct sunlight.', waterproofing: 'Waterproofing:', waterproofing_desc: 'A critical first step to prevent leaks.', potting_mix: 'Potting Mix:', potting_mix_desc: 'Use a lightweight mix to reduce roof load.', plant_selection: 'Plant Selection:', plant_selection_desc: 'Choose vegetables like tomatoes, chili, mint.', pest_control: 'Pest Control:', pest_control_desc: 'Use organic methods like neem oil.', contact_title: 'Need Help? Contact Us! 💬', contact_desc: 'For any agricultural queries, reach out!', toll_free: 'Toll-Free Number:', email: 'Email Address:', delete_options_title: 'Delete Options', delete_this_chat_button: 'Delete This Chat', delete_all_chats_button: 'Delete All Chats', voice_listening: 'Listening...', cancel_button: 'Cancel', ok_button: 'OK', choose_file: 'Choose File', humidity: 'Humidity', wind: 'Wind', lang_en: 'English', lang_ml: 'Malayalam', lang_hi: 'Hindi', lang_ta: 'Tamil' },
            'ta-IN': { title: 'வேளாண் உதவியாளர்', new_chat: 'புதிய உரையாடல்', search_placeholder: 'தேடு...', recent: 'சமீபத்தியவை', welcome_message: "வணக்கம்! எப்படி உதவட்டும்?", type_query_placeholder: 'உங்கள் வினவலை தட்டச்சு செய்க...', send_button: 'அனுப்பு', analyze_image_button: 'படத்தை பகுப்பாய்வு செய்', delete_chat_button: 'உரையாடலை நீக்கு', terrace_guide_title: 'மொட்டைமாடி விவசாய வழிகாட்டி', terrace_guide_desc: 'உங்கள் மொட்டை மாடியில் பசுமையான தோட்டத்தை உருவாக்குவது எப்படி.', sunlight: 'சூரிய ஒளி:', sunlight_desc: '5-6 மணிநேர நேரடி சூரிய ஒளி தேவை.', waterproofing: 'நீர்ப்புகாப்பு:', waterproofing_desc: 'கசிவுகளைத் தடுக்க முதல் படி.', potting_mix: 'மண் கலவை:', potting_mix_desc: 'இலகுரக கலவையைப் பயன்படுத்தவும்.', plant_selection: 'தாவரத் தேர்வு:', plant_selection_desc: 'தக்காளி, மிளகாய், புதினா தேர்ந்தெடுக்கவும்.', pest_control: 'பூச்சி கட்டுப்பாடு:', pest_control_desc: 'வேப்பெண்ணெய் போன்ற இயற்கை முறைகளைப் பயன்படுத்தவும்.', contact_title: 'உதவி தேவையா? 💬', contact_desc: 'விவசாய வினவல்களுக்கு, எங்களை அணுகவும்!', toll_free: 'இலவச அழைப்பு எண்:', email: 'மின்னஞ்சல் முகவரி:', delete_options_title: 'நீக்குதல் விருப்பங்கள்', delete_this_chat_button: 'இந்த உரையாடலை நீக்கு', delete_all_chats_button: 'அனைத்து உரையாடல்களையும் நீக்கு', voice_listening: 'கேட்கிறது...', cancel_button: 'ரத்துசெய்', ok_button: 'சரி', choose_file: 'கோப்பைத் தேர்ந்தெடு', humidity: 'ஈரப்பதம்', wind: 'காற்று', lang_en: 'ஆங்கிலம்', lang_ml: 'மலையாளம்', lang_hi: 'இந்தி', lang_ta: 'தமிழ்' },
            'hi-IN': { title: 'कृषि-सहायक', new_chat: 'नई चैट', search_placeholder: 'खोजें...', recent: 'हाल के', welcome_message: "नमस्ते! मैं कैसे मदद कर सकता हूँ?", type_query_placeholder: 'अपना प्रश्न लिखें...', send_button: 'भेजें', analyze_image_button: 'छवि का विश्लेषण करें', delete_chat_button: 'चैट हटाएं', terrace_guide_title: 'छत पर खेती की गाइड', terrace_guide_desc: 'एक छत पर अपना खुद का हरा-भरा बगीचा बनाएं।', sunlight: 'धूप:', sunlight_desc: '5-6 घंटे की सीधी धूप सुनिश्चित करें।', waterproofing: 'वॉटरप्रूफिंग:', waterproofing_desc: 'लीक को रोकने के लिए एक महत्वपूर्ण पहला कदम।', potting_mix: 'पॉटिंग मिक्स:', potting_mix_desc: 'छत का भार कम करने के लिए हल्के मिश्रण का उपयोग करें।', plant_selection: 'पौधों का चयन:', plant_selection_desc: 'टमाटर, मिर्च, पुदीना जैसी सब्जियां चुनें।', pest_control: 'कीट नियंत्रण:', pest_control_desc: 'नीम तेल जैसे जैविक तरीकों का प्रयोग करें।', contact_title: 'मदद चाहिए? संपर्क करें! 💬', contact_desc: 'किसी भी कृषि प्रश्न के लिए, संपर्क करें!', toll_free: 'टोल-फ्री नंबर:', email: 'ईमेल पता:', delete_options_title: 'विकल्प हटाएं', delete_this_chat_button: 'इस चैट को हटाएं', delete_all_chats_button: 'सभी चैट हटाएं', voice_listening: 'सुन रहा हूँ...', cancel_button: 'रद्द करें', ok_button: 'ठीक है', choose_file: 'फ़ाइल चुनें', humidity: 'नमी', wind: 'हवा', lang_en: 'अंग्रेज़ी', lang_ml: 'मलयालम', lang_hi: 'हिंदी', lang_ta: 'तमिल' },
            'ml-IN': { title: 'അഗ്രി-അസിസ്റ്റന്റ്', new_chat: 'പുതിയ ചാറ്റ്', search_placeholder: 'തിരയുക...', recent: 'സമീപകാലം', welcome_message: "സ്വാഗതം! ഞാനെങ്ങനെ സഹായിക്കേണ്ടു?", type_query_placeholder: 'നിങ്ങളുടെ ചോദ്യം ടൈപ്പ് ചെയ്യുക...', send_button: 'അയയ്ക്കുക', analyze_image_button: 'ചിത്രം വിശകലനം ചെയ്യുക', delete_chat_button: 'ചാറ്റ് ഇല്ലാതാക്കുക', terrace_guide_title: 'ടെറസ് ഫാമിംഗ് ഗൈഡ്', terrace_guide_desc: 'ഒരു മേൽക്കൂരയിൽ നിങ്ങളുടെ സ്വന്തം പൂന്തോട്ടം ഉണ്ടാക്കുക.', sunlight: 'സൂര്യപ്രകാശം:', sunlight_desc: '5-6 മണിക്കൂർ നേരിട്ടുള്ള സൂര്യപ്രകാശം ഉറപ്പാക്കുക.', waterproofing: 'വാട്ടർപ്രൂഫിംഗ്:', waterproofing_desc: 'ചോർച്ച തടയുന്നതിനുള്ള ഒരു നിർണായക ആദ്യപടി.', potting_mix: 'പോട്ടിംഗ് മിശ്രിതം:', potting_mix_desc: 'മേൽക്കൂരയുടെ ഭാരം കുറയ്ക്കാൻ ഭാരം കുറഞ്ഞ മിശ്രിതം ഉപയോഗിക്കുക.', plant_selection: 'ചെടി തിരഞ്ഞെടുക്കൽ:', plant_selection_desc: 'തക്കാളി, മുളക്, പുതിന തുടങ്ങിയ പച്ചക്കറികൾ തിരഞ്ഞെടുക്കുക.', pest_control: 'കീട നിയന്ത്രണം:', pest_control_desc: 'വേപ്പെണ്ണ പോലുള്ള ജൈവ രീതികൾ ഉപയോഗിക്കുക.', contact_title: 'സഹായം വേണോ? ഞങ്ങളെ സമീപിക്കുക! 💬', contact_desc: 'ഏത് കാർഷിക സംശയങ്ങൾക്കും ബന്ധപ്പെടുക!', toll_free: 'ടോൾ ഫ്രീ നമ്പർ:', email: 'ഇമെയിൽ വിലാസം:', delete_options_title: 'ഓപ്ഷനുകൾ ഇല്ലാതാക്കുക', delete_this_chat_button: 'ഈ ചാറ്റ് ഇല്ലാതാക്കുക', delete_all_chats_button: 'എല്ലാ ചാറ്റുകളും ഇല്ലാതാക്കുക', voice_listening: 'കേൾക്കുന്നു...', cancel_button: 'റദ്ദാക്കുക', ok_button: 'ശരി', choose_file: 'ഫയൽ തിരഞ്ഞെടുക്കുക', humidity: 'ഈർപ്പം', wind: 'കാറ്റ്', lang_en: 'ഇംഗ്ലീഷ്', lang_ml: 'മലയാളം', lang_hi: 'ഹിന്ദി', lang_ta: 'തമിഴ്' }
        };

        // --- DOM Elements ---
        const DOMElements = {
            chatHistory: document.getElementById('chat-history'), userInput: document.getElementById('user-input'), sendButton: document.getElementById('send-button'), voiceButton: document.getElementById('voice-button'), languageSelect: document.getElementById('language-select'), deleteChatButton: document.getElementById('delete-chat-button'), loadingModal: document.getElementById('loading-modal'), customModal: document.getElementById('custom-modal'), modalTitle: document.getElementById('modal-title'), modalMessage: document.getElementById('modal-message'), modalOkButton: document.getElementById('modal-ok-button'), modalCancelButton: document.getElementById('modal-cancel-button'), newChatButton: document.getElementById('new-chat-button'), recentChatsList: document.getElementById('recent-chats-list'), searchChatsInput: document.getElementById('search-chats'), menuToggle: document.getElementById('menu-toggle'), sidebar: document.getElementById('sidebar'), deleteOptionsModal: document.getElementById('delete-options-modal'), deleteThisChatOptionButton: document.getElementById('delete-this-chat-option-button'), deleteAllChatsOptionButton: document.getElementById('delete-all-chats-option-button'), deleteOptionsCancelButton: document.getElementById('delete-options-cancel-button'), uploadButton: document.getElementById('upload-button'), imageUpload: document.getElementById('image-upload'), timeDisplay: document.getElementById('time-display'), dateDisplay: document.getElementById('date-display'), voiceModal: document.getElementById('voice-modal'), stopVoiceButton: document.getElementById('stop-voice-button'), getLocationButton: document.getElementById('get-location-button'), fileNameDisplay: document.getElementById('file-name-display')
        };
        
        // --- UI Functions ---
        const showLoading = (show) => DOMElements.loadingModal.classList.toggle('hidden', !show);
        const showModal = (title, message, showCancelButton = false) => {
            const modalHeader = document.getElementById('modal-header');
            DOMElements.modalTitle.textContent = title;
            DOMElements.modalMessage.textContent = message;
            DOMElements.modalCancelButton.style.display = showCancelButton ? 'inline-block' : 'none';
            
            const isDeleteAction = modalAction && modalAction.toLowerCase().includes('delete');
            
            if (isDeleteAction) {
                modalHeader.style.background = 'linear-gradient(120deg, #b91c1c, #ef4444)';
                DOMElements.modalOkButton.style.background = 'linear-gradient(120deg, #b91c1c, #ef4444)';
            } else {
                modalHeader.style.background = 'linear-gradient(120deg, #1e40af, #3b82f6)';
                DOMElements.modalOkButton.style.background = 'linear-gradient(120deg, #1e40af, #3b82f6)';
            }
            DOMElements.customModal.classList.remove('hidden');
        };
        const updateLanguage = (lang) => {
            const langData = translations[lang] || translations['en-US'];
            document.querySelectorAll('[data-translate]').forEach(el => {
                el.textContent = langData[el.dataset.translate] || el.textContent
            });
            document.querySelectorAll('[data-translate-placeholder]').forEach(el => el.placeholder = langData[el.dataset.translatePlaceholder] || el.placeholder);
            localStorage.setItem('preferredLanguage', lang);
        };
        const parseMarkdown = (text) => {
            let html = text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>').replace(/### (.*)/g, '<h3>$1</h3>');
            const listItems = html.match(/^\* (.*)/gm);
            if (listItems) {
                html = html.replace(/^\* (.*)/gm, '') + '<ul>' + listItems.map(item => `<li>${item.substring(2)}</li>`).join('') + '</ul>';
            }
            return html.replace(/\n/g, '<br>');
        };
        const addMessageToChat = (text, sender, imageUrl = null) => {
            const messageEl = document.createElement('div');
            messageEl.classList.add('message-box', sender === 'user' ? 'user-message' : 'ai-message');
            
            let content = sender === 'ai' ? parseMarkdown(text) : `<p>${text}</p>`;
            let speakerButtonHTML = sender === 'ai' 
                ? `<button class="speaker-button" data-text="${encodeURIComponent(text)}">
                        <svg class="play-icon h-5 w-5 text-gray-600" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path d="M6.3 2.841A1.5 1.5 0 004 4.11V15.89a1.5 1.5 0 002.3 1.269l9.344-5.89a1.5 1.5 0 000-2.538L6.3 2.84z"/></svg>
                        <svg class="stop-icon h-5 w-5 text-gray-600 hidden" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path d="M5 5h10v10H5V5z" /></svg>
                    </button>` 
                : '';
            
            messageEl.innerHTML = `<strong>${sender === 'user' ? 'You' : 'Agri-Assistant'}:</strong><div class="message-content pr-8">${content}</div>${speakerButtonHTML}`;

            if (imageUrl) {
                const imgEl = document.createElement('img');
                imgEl.src = imageUrl;
                imgEl.classList.add('mt-2', 'rounded-lg', 'max-w-full', 'h-auto', 'max-h-52');
                messageEl.querySelector('.message-content').appendChild(imgEl);
            }

            DOMElements.chatHistory.appendChild(messageEl);
            DOMElements.chatHistory.scrollTop = DOMElements.chatHistory.scrollHeight;
        };

        // --- Real-time Info & Weather ---
        const updateRealtimeInfo = () => {
            const now = new Date();
            const langCode = DOMElements.languageSelect.value;
            DOMElements.timeDisplay.textContent = now.toLocaleTimeString(langCode.split('-')[0], { hour: '2-digit', minute: '2-digit' });
            DOMElements.dateDisplay.textContent = now.toLocaleDateString(langCode.split('-')[0], { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
        };
        
        const updateWeatherUI = (data) => {
            if (!data || !data.description) return;
            document.getElementById('weather-container').classList.remove('hidden');
            document.getElementById('weather-icon').textContent = data.icon || '🌡️';
            document.getElementById('weather-desc').textContent = data.description;
            document.getElementById('humidity-display').textContent = data.humidity;
            document.getElementById('wind-display').textContent = data.windSpeed;
        };

        const fetchWeatherData = async (lat, lon) => {
            const prompt = `Based on the latest Google Weather data for latitude ${lat} and longitude ${lon}, provide ONLY a JSON object with the current weather. The JSON object must have these exact keys: "description" (a short string like "Sunny", "Partly Cloudy"), "humidity" (integer), "windSpeed" (integer in km/h), and "icon" (a single appropriate emoji like '☀️', '☁️', '🌧️'). Do not include any other text or markdown formatting.`;
            const payload = { contents: [{ parts: [{ text: prompt }] }] };
            // FIX: Use updated model name
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${geminiApiKey}`;

            try {
                const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                if (!response.ok) throw new Error('Weather API fetch failed');
                const result = await response.json();
                let text = result?.candidates?.[0]?.content?.parts?.[0]?.text;
                text = text.replace(/```json/g, '').replace(/```/g, '').trim();
                const weatherData = JSON.parse(text);
                updateWeatherUI(weatherData);
            } catch (error) {
                console.error("Failed to fetch or parse weather data:", error);
            }
        };

        const getWeather = () => {
             if (navigator.geolocation) {
                  navigator.geolocation.getCurrentPosition(
                        async (position) => {
                             DOMElements.getLocationButton.classList.add('hidden');
                             await fetchWeatherData(position.coords.latitude, position.coords.longitude);
                        },
                        () => {
                             DOMElements.getLocationButton.classList.remove('hidden');
                             console.log("User denied geolocation.");
                        }
                  );
             } else {
                  console.log("Geolocation is not supported by this browser.");
             }
        };

        // --- Firestore & Chat Logic ---
        const loadRecentChats = async () => {
            if (!userId) return;
            const chatsRef = collection(db, 'users', userId, 'chats');
            const querySnapshot = await getDocs(chatsRef);
            DOMElements.recentChatsList.innerHTML = '';
            
            const chats = [];
            querySnapshot.forEach(doc => chats.push({ id: doc.id, ...doc.data() }));
            chats.sort((a, b) => (b.timestamp?.toMillis() || 0) - (a.timestamp?.toMillis() || 0));

            chats.forEach(chat => {
                const firstMessage = chat.history?.[0]?.text || 'New Chat';
                const chatEl = document.createElement('button');
                chatEl.className = 'w-full text-left p-2 rounded-lg hover:bg-blue-100 text-sm truncate transition-colors';
                chatEl.textContent = firstMessage;
                chatEl.dataset.chatId = chat.id;
                chatEl.addEventListener('click', () => loadChatHistory(chat.id));
                DOMElements.recentChatsList.appendChild(chatEl);
            });
        };
        const startNewChat = () => {
            if (chatHistoryUnsubscribe) chatHistoryUnsubscribe();
            currentChatId = null;
            localChatHistory = [];
            DOMElements.chatHistory.innerHTML = ''; 
            const lang = DOMElements.languageSelect.value || 'en-US';
            addMessageToChat(translations[lang].welcome_message, 'ai');
            document.querySelectorAll('#recent-chats-list button').forEach(btn => {
                btn.classList.remove('bg-blue-200', 'font-semibold');
            });
        };
        const loadChatHistory = (chatId) => {
            if (chatHistoryUnsubscribe) chatHistoryUnsubscribe();
            currentChatId = chatId;
            const docRef = doc(db, 'users', userId, 'chats', chatId);
            
            chatHistoryUnsubscribe = onSnapshot(docRef, (doc) => {
                DOMElements.chatHistory.innerHTML = '';
                if (doc.exists()) {
                    localChatHistory = doc.data().history || [];
                    localChatHistory.forEach(msg => addMessageToChat(msg.text, msg.sender, msg.imageUrl));
                } else {
                    console.error("Chat document does not exist!");
                    startNewChat();
                }
            });
            document.querySelectorAll('#recent-chats-list button').forEach(btn => {
                btn.classList.toggle('bg-blue-200', btn.dataset.chatId === chatId);
                btn.classList.toggle('font-semibold', btn.dataset.chatId === chatId);
            });
        };
        const saveChatHistory = async () => {
             if (!userId) return;
            const historyToSave = [...localChatHistory];
            if (historyToSave.length === 0) return;

            try {
                if (currentChatId) {
                    const docRef = doc(db, 'users', userId, 'chats', currentChatId);
                    await setDoc(docRef, { history: historyToSave, timestamp: serverTimestamp() }, { merge: true });
                } else {
                    const chatsRef = collection(db, 'users', userId, 'chats');
                    const newDocRef = await addDoc(chatsRef, { history: historyToSave, timestamp: serverTimestamp() });
                    currentChatId = newDocRef.id;
                    await loadRecentChats();
                    loadChatHistory(currentChatId);
                }
            } catch(error) {
                console.error("Error saving chat history: ", error);
                showModal("Error", "Could not save your chat. Please try again.");
            }
        };

        const deleteThisChat = async () => {
            if (!userId || !currentChatId) {
                showModal("Error", "No active chat selected to delete.");
                return;
            }
            await deleteDoc(doc(db, 'users', userId, 'chats', currentChatId));
            await loadRecentChats();
            startNewChat();
        };
        
        const deleteSpecificChat = async (chatId) => {
            if (!userId || !chatId) {
                showModal("Error", "Chat ID not found for deletion.");
                return;
            }
            showLoading(true);
            try {
                await deleteDoc(doc(db, 'users', userId, 'chats', chatId));
                if (currentChatId === chatId) {
                    startNewChat();
                }
                await loadRecentChats();
            } catch (error) {
                console.error("Error deleting specific chat:", error);
                showModal("Error", "Could not delete the chat.");
            } finally {
                showLoading(false);
            }
        };

        const deleteAllChats = async () => {
            if (!userId) return;
            const chatsRef = collection(db, 'users', userId, 'chats');
            const querySnapshot = await getDocs(chatsRef);
            const batch = writeBatch(db);
            querySnapshot.forEach(doc => batch.delete(doc.ref));
            await batch.commit();
            await loadRecentChats();
            startNewChat();
        };


        // --- Core API Call Logic ---
        const handleTextQuery = async (query) => {
            if (!query.trim()) return;
            
            addMessageToChat(query, 'user');
            localChatHistory.push({ text: query, sender: 'user'});
            await saveChatHistory();

            showLoading(true);
            
            const geminiPayload = localChatHistory.map(msg => ({
                role: msg.sender === 'user' ? 'user' : 'model',
                parts: [{ text: msg.text }]
            }));
            
            const systemPrompt = `You are Friday, a specialized AI Agri-Assistant. Your knowledge is grounded in real-time, verifiable agricultural data.
**PRIMARY DIRECTIVE:** You ONLY answer questions related to agriculture, farming, gardening, crop science, pest control, soil health, and related topics.
- If the user asks a non-agricultural question (e.g., about history, movies, coding, general chit-chat), you MUST respond with: "I can only assist with agriculture-related queries. How can I help you with your farming needs today?" in the user's language.
**RESPONSE GUIDELINES:**
1.  **Accuracy is Paramount:** For any recommendations (pesticides, fertilizers, farming techniques), provide specific, accurate information.
2.  **Pesticide Safety:** When recommending pesticides (both organic and chemical), ALWAYS include: The specific active ingredient, clear dosage and application instructions, and a strong warning about safety precautions (e.g., wearing protective gear).
3.  **Formatting:** Use Markdown for clarity ('### Title', '* ' for bullet points, '**bold**'). NEVER use long, unbroken paragraphs.
4.  **Practicality:** Give actionable, step-by-step advice.
5.  **Location Context:** The user is in Malumichampatti, Tamil Nadu, India. The date is ${new Date().toLocaleDateString()}. Use this for context-aware advice.
6.  **Language:** Respond ONLY in ${DOMElements.languageSelect.options[DOMElements.languageSelect.selectedIndex].text}.
7.  **Engage:** Always conclude your response with a relevant follow-up question.`;

            const payload = { 
                contents: geminiPayload, 
                tools: [{ "google_search": {} }],
                systemInstruction: { parts: [{ text: systemPrompt }] } 
            };
            // FIX: Use updated model name
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${geminiApiKey}`;

            try {
                const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                if (!response.ok) throw new Error(`API Error: ${response.status}`);
                const result = await response.json();
                const text = result?.candidates?.[0]?.content?.parts?.[0]?.text;
                if (text) {
                    addMessageToChat(text, 'ai');
                    localChatHistory.push({ text: text, sender: 'ai' });
                    await saveChatHistory();
                    if (isVoiceInteraction) {
                        speakText(text, null);
                        isVoiceInteraction = false;
                    }
                } else { addMessageToChat("Sorry, I couldn't get a response.", 'ai'); }
            } catch (error) { showModal("Error", `Failed to get a response: ${error.message}`); } 
            finally { showLoading(false); }
        };
        const handleImageAnalysis = async (base64ImageData) => { 
            showLoading(true);
            const prompt = "Analyze this agricultural image. Identify any visible plant diseases, pests, or nutrient deficiencies. If a problem is identified, suggest organic and chemical pesticide recommendations with dosages. If it's not an agricultural image, state that you can only analyze farming-related pictures.";
            addMessageToChat("Analyzing your image...", 'user', base64ImageData);
            localChatHistory.push({ text: "Analyzing your image...", sender: 'user', imageUrl: base64ImageData });

            const payload = {
                contents: [{ parts: [{ text: prompt }, { inlineData: { mimeType: "image/jpeg", data: base64ImageData.split(',')[1] } }] }]
            };
            // FIX: Use updated model name
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${geminiApiKey}`;

            try {
                const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                if (!response.ok) throw new Error(`API Error: ${response.status}`);
                const result = await response.json();
                const text = result?.candidates?.[0]?.content?.parts?.[0]?.text;
                 if (text) {
                    addMessageToChat(text, 'ai');
                    localChatHistory.push({ text: text, sender: 'ai' });
                    await saveChatHistory();
                } else { addMessageToChat("Sorry, I could not analyze the image.", 'ai'); }
            } catch (error) { showModal("Error", `Image analysis failed: ${error.message}`); }
            finally { showLoading(false); }
           };
        
        // --- Voice Synthesis and Recognition ---
        const recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
        recognition.interimResults = false;
        recognition.addEventListener('result', e => {
            DOMElements.voiceModal.classList.add('hidden');
            handleTextQuery(e.results[0][0].transcript);
        });
        recognition.addEventListener('end', () => DOMElements.voiceModal.classList.add('hidden'));
        recognition.addEventListener('error', (e) => showModal('Voice Error', `Recognition error: ${e.error}`));
        
        const speakText = (text, button) => {
            if (speechSynthesis.speaking) {
                speechSynthesis.cancel();
                if (currentUtterance && currentUtterance.text === text) {
                    currentUtterance = null;
                    return;
                }
            }
            
            currentUtterance = new SpeechSynthesisUtterance(text);
            currentUtterance.lang = DOMElements.languageSelect.value;
            
            document.querySelectorAll('.play-icon').forEach(i => i.classList.remove('hidden'));
            document.querySelectorAll('.stop-icon').forEach(i => i.classList.add('hidden'));

            if(button) {
                const playIcon = button.querySelector('.play-icon');
                const stopIcon = button.querySelector('.stop-icon');
                currentUtterance.onstart = () => { playIcon.classList.add('hidden'); stopIcon.classList.remove('hidden'); };
                currentUtterance.onend = () => { playIcon.classList.remove('hidden'); stopIcon.classList.add('hidden'); currentUtterance = null; };
                currentUtterance.onerror = () => { playIcon.classList.remove('hidden'); stopIcon.classList.add('hidden'); currentUtterance = null; };
            } else {
                 currentUtterance.onend = () => { currentUtterance = null; };
                 currentUtterance.onerror = () => { currentUtterance = null; };
            }
            speechSynthesis.speak(currentUtterance);
        };

        // --- Event Listeners ---
        DOMElements.sendButton.addEventListener('click', () => { handleTextQuery(DOMElements.userInput.value); DOMElements.userInput.value = ''; });
        DOMElements.userInput.addEventListener('keypress', (e) => e.key === 'Enter' && DOMElements.sendButton.click());
        DOMElements.imageUpload.addEventListener('change', () => {
            const file = DOMElements.imageUpload.files[0];
            DOMElements.fileNameDisplay.textContent = file ? file.name : '';
        });
        DOMElements.uploadButton.addEventListener('click', () => { 
            const file = DOMElements.imageUpload.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => handleImageAnalysis(e.target.result);
                reader.readAsDataURL(file);
                 DOMElements.imageUpload.value = ''; // Reset file input
                 DOMElements.fileNameDisplay.textContent = ''; // Clear file name display
            } else {
                showModal("No File Selected", "Please choose an image file to analyze.");
            }
        });
        DOMElements.deleteChatButton.addEventListener('click', () => DOMElements.deleteOptionsModal.classList.remove('hidden'));
        DOMElements.deleteOptionsCancelButton.addEventListener('click', () => DOMElements.deleteOptionsModal.classList.add('hidden'));
        DOMElements.deleteThisChatOptionButton.addEventListener('click', () => {
            DOMElements.deleteOptionsModal.classList.add('hidden');
            modalAction = 'deleteThisChat';
            showModal('Confirm Deletion', 'Are you sure you want to delete this chat?', true);
        });
        DOMElements.deleteAllChatsOptionButton.addEventListener('click', () => {
             DOMElements.deleteOptionsModal.classList.add('hidden');
            modalAction = 'deleteAllChats';
            showModal('Confirm Deletion', 'Are you sure you want to delete ALL chats?', true);
        });
        DOMElements.voiceButton.addEventListener('click', () => {
            isVoiceInteraction = true;
            recognition.lang = DOMElements.languageSelect.value;
            DOMElements.voiceModal.classList.remove('hidden');
            DOMElements.voiceModal.classList.add('flex');
            recognition.start();
        });
        DOMElements.stopVoiceButton.addEventListener('click', () => recognition.stop());
        DOMElements.modalOkButton.addEventListener('click', async () => {
            DOMElements.customModal.classList.add('hidden');
            if (modalAction === 'deleteThisChat') await deleteThisChat();
            if (modalAction === 'deleteAllChats') await deleteAllChats();
            if (modalAction === 'deleteSpecificChat') {
                const chatId = DOMElements.modalOkButton.dataset.chatIdToDelete;
                if (chatId) await deleteSpecificChat(chatId);
            }
            modalAction = null;
            delete DOMElements.modalOkButton.dataset.chatIdToDelete;
        });
        DOMElements.modalCancelButton.addEventListener('click', () => DOMElements.customModal.classList.add('hidden'));
        DOMElements.newChatButton.addEventListener('click', startNewChat);
        DOMElements.menuToggle.addEventListener('click', () => DOMElements.sidebar.classList.toggle('-translate-x-full'));
        DOMElements.languageSelect.addEventListener('change', (e) => updateLanguage(e.target.value));
        DOMElements.chatHistory.addEventListener('click', (e) => {
            const speakerButton = e.target.closest('.speaker-button');
            if (speakerButton) speakText(decodeURIComponent(speakerButton.dataset.text), speakerButton);
        });
        DOMElements.recentChatsList.addEventListener('contextmenu', (e) => {
            e.preventDefault();
            const chatButton = e.target.closest('button[data-chat-id]');
            if (chatButton) {
                const chatIdToDelete = chatButton.dataset.chatId;
                modalAction = 'deleteSpecificChat';
                DOMElements.modalOkButton.dataset.chatIdToDelete = chatIdToDelete;
                showModal('Confirm Deletion', `Are you sure you want to delete this chat?`, true);
            }
        });
        DOMElements.getLocationButton.addEventListener('click', getWeather);


        // --- Initial Page Load ---
        const savedLang = localStorage.getItem('preferredLanguage') || 'en-US';
        DOMElements.languageSelect.value = savedLang;
        updateLanguage(savedLang);
        updateRealtimeInfo();
        setInterval(updateRealtimeInfo, 60000);
        getWeather(); // Attempt to get weather on load
    </script>
</body>
</html>
