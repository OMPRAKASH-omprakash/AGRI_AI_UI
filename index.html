<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Agri AI Assistant</title>
    <link href="https://fonts.googleapis.com/css2?family=Söhne:wght@400;500;600&family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['"Söhne"', '"Inter"', 'sans-serif'] },
                    colors: {
                        gpt: { 50: '#f9f9f9', 100: '#ececec', 200: '#e3e3e3', 800: '#343541', 900: '#202123' },
                        agri: { 500: '#10a37f', 600: '#0d8a6a' }
                    },
                    animation: { 'fade-in': 'fadeIn 0.3s ease-out' },
                    keyframes: { fadeIn: { '0%': { opacity: '0', transform: 'translateY(5px)' }, '100%': { opacity: '1', transform: 'translateY(0)' } } }
                }
            }
        }
    </script>
    <style>
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-thumb { background-color: #d1d5db; border-radius: 3px; }
        ::-webkit-scrollbar-track { background: transparent; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        
        #sidebar, #tools-panel, #main-content { transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        
        .sidebar-closed { width: 0 !important; padding: 0 !important; overflow: hidden !important; opacity: 0; }
        .sidebar-open { width: 260px !important; opacity: 1; }
        
        .voice-active { animation: pulse 1.5s infinite; }
        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(16, 163, 127, 0.4); } 70% { box-shadow: 0 0 0 15px rgba(16, 163, 127, 0); } 100% { box-shadow: 0 0 0 0 rgba(16, 163, 127, 0); } }
    </style>
</head>
<body class="bg-white h-screen flex text-gray-800 font-sans overflow-hidden">

    <!-- LEFT SIDEBAR -->
    <aside id="sidebar" class="fixed inset-y-0 left-0 z-50 bg-gpt-900 text-white flex flex-col h-full border-r border-black/10 w-[260px] lg:relative lg:translate-x-0 transform -translate-x-full lg:transform-none">
        <div class="p-3 flex items-center justify-between">
            <button onclick="app.newChat()" class="flex-1 flex items-center gap-3 px-3 py-3 rounded-md border border-white/20 hover:bg-white/10 transition-colors text-sm text-white text-left">
                <i data-lucide="plus" class="w-4 h-4"></i> New chat
            </button>
            <button onclick="app.toggleLeft()" class="lg:hidden ml-2 p-2 hover:bg-white/10 rounded-md text-gray-400">
                <i data-lucide="x" class="w-5 h-5"></i>
            </button>
        </div>
        <div class="flex-1 overflow-y-auto px-3 py-2 space-y-2 no-scrollbar" id="chat-list">
            <div class="text-xs font-semibold text-gray-500 px-3 py-2">History</div>
        </div>
        <div class="p-3 border-t border-white/20">
            <div class="flex items-center gap-3 px-3 py-3 hover:bg-white/10 rounded-md cursor-pointer transition-colors">
                <div class="w-8 h-8 bg-agri-500 rounded-sm flex items-center justify-center text-white font-bold text-xs">U</div>
                <div class="text-sm font-medium">Agri User</div>
            </div>
        </div>
    </aside>

    <!-- MOBILE OVERLAY -->
    <div id="mobile-overlay" onclick="app.toggleLeft()" class="fixed inset-0 bg-black/50 z-40 hidden lg:hidden"></div>

    <!-- MAIN CONTENT -->
    <main id="main-content" class="flex-1 flex flex-col h-full relative bg-white min-w-0">
        <header class="h-14 flex items-center justify-between px-4 border-b border-gray-100 lg:border-none sticky top-0 bg-white/90 backdrop-blur z-40">
            <div class="flex items-center gap-2">
                <button onclick="app.toggleLeft()" class="p-2 hover:bg-gray-100 rounded-md text-gray-500" title="Toggle Sidebar">
                    <i data-lucide="panel-left" class="w-5 h-5"></i>
                </button>
                <div class="flex items-center gap-1.5 text-gray-700 font-semibold cursor-pointer hover:bg-gray-50 px-2 py-1 rounded-md transition">
                    Agri Assistant <span class="text-gray-400"></span>
                </div>
            </div>
            <div class="flex items-center gap-2">
                <select id="lang-select" onchange="app.setLang(this.value)" class="bg-transparent text-sm font-medium text-gray-600 focus:outline-none cursor-pointer">
                    <option value="en-US">EN</option>
                    <option value="ml-IN">ML</option>
                    <option value="ta-IN">TA</option>
                </select>
                <button onclick="app.toggleRight()" class="p-2 hover:bg-gray-100 rounded-md text-gray-500 relative" title="Tools">
                    <i data-lucide="layout-grid" class="w-5 h-5"></i>
                </button>
            </div>
        </header>

        <div id="chat-container" class="flex-1 overflow-y-auto w-full scroll-smooth">
            <div id="welcome-screen" class="flex flex-col items-center justify-center min-h-[60vh] text-center opacity-100 transition-opacity duration-300 max-w-4xl mx-auto px-4">
                <div class="w-16 h-16 bg-white border border-gray-200 rounded-full flex items-center justify-center mb-6 shadow-sm">
                    <i data-lucide="sprout" class="w-8 h-8 text-agri-500"></i>
                </div>
                <h2 class="text-2xl font-semibold text-gray-800 mb-8">How can I help your farm today?</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3 w-full px-4">
                    <button onclick="app.tool('plan')" class="p-4 border border-gray-200 rounded-xl text-left hover:bg-gray-50 text-sm text-gray-600 transition flex items-center gap-3">
                        <span class="p-2 bg-blue-100 rounded-lg text-blue-600"><i data-lucide="calendar" class="w-4 h-4"></i></span>
                        Create a crop plan
                    </button>
                    <button onclick="app.tool('pest')" class="p-4 border border-gray-200 rounded-xl text-left hover:bg-gray-50 text-sm text-gray-600 transition flex items-center gap-3">
                        <span class="p-2 bg-red-100 rounded-lg text-red-600"><i data-lucide="bug" class="w-4 h-4"></i></span>
                        Identify a pest
                    </button>
                    <button onclick="app.tool('price')" class="p-4 border border-gray-200 rounded-xl text-left hover:bg-gray-50 text-sm text-gray-600 transition flex items-center gap-3">
                        <span class="p-2 bg-green-100 rounded-lg text-green-600"><i data-lucide="trending-up" class="w-4 h-4"></i></span>
                        Check market prices
                    </button>
                    <button onclick="app.tool('soil')" class="p-4 border border-gray-200 rounded-xl text-left hover:bg-gray-50 text-sm text-gray-600 transition flex items-center gap-3">
                        <span class="p-2 bg-amber-100 rounded-lg text-amber-600"><i data-lucide="mountain" class="w-4 h-4"></i></span>
                        Analyze Soil
                    </button>
                    <button onclick="app.tool('water')" class="p-4 border border-gray-200 rounded-xl text-left hover:bg-gray-50 text-sm text-gray-600 transition flex items-center gap-3">
                        <span class="p-2 bg-sky-100 rounded-lg text-sky-600"><i data-lucide="droplets" class="w-4 h-4"></i></span>
                        Irrigation Advice
                    </button>
                    <button onclick="app.tool('tip')" class="p-4 border border-gray-200 rounded-xl text-left hover:bg-gray-50 text-sm text-gray-600 transition flex items-center gap-3">
                        <span class="p-2 bg-yellow-100 rounded-lg text-yellow-600"><i data-lucide="lightbulb" class="w-4 h-4"></i></span>
                        Get farming tips
                    </button>
                </div>
            </div>
            <div id="chat-history" class="max-w-3xl mx-auto px-4 py-8 space-y-6"></div>
            <div class="h-24 w-full"></div>
        </div>

        <div class="w-full border-t border-transparent bg-gradient-to-t from-white via-white to-transparent pt-10 pb-6 px-4 absolute bottom-0 z-30">
            <div class="max-w-3xl mx-auto relative">
                <div id="file-preview" class="hidden mb-2 px-4 py-2 bg-gray-50 rounded-lg border border-gray-200 text-xs text-gray-600 flex items-center justify-between w-fit">
                    <span id="file-name" class="truncate max-w-[200px]"></span>
                    <button onclick="app.clearFile()" class="ml-2 hover:text-red-500"><i data-lucide="x" class="w-3 h-3"></i></button>
                </div>
                <div class="relative flex items-end w-full p-3 bg-white border border-gray-300 rounded-2xl shadow-sm focus-within:ring-1 focus-within:ring-agri-500 focus-within:border-agri-500 transition-all">
                    <button onclick="$('file-upload').click()" class="p-2 text-gray-400 hover:text-gray-600 transition-colors" title="Attach">
                        <i data-lucide="paperclip" class="w-5 h-5"></i>
                        <input type="file" id="file-upload" class="hidden" onchange="app.handleFile(this)" accept="image/*">
                    </button>
                    <textarea id="user-input" rows="1" placeholder="Send a message..." class="flex-1 max-h-[200px] py-2 px-3 bg-transparent border-none focus:ring-0 text-gray-800 placeholder-gray-400 resize-none text-base" oninput="this.style.height='auto';this.style.height=this.scrollHeight+'px'" onkeydown="if(event.key==='Enter'&&!event.shiftKey){event.preventDefault();app.send()}"></textarea>
                    <button onclick="app.toggleVoice()" class="p-2 text-gray-400 hover:text-gray-600 transition-colors" title="Voice">
                        <i data-lucide="mic" class="w-5 h-5"></i>
                    </button>
                    <button onclick="app.send()" id="send-btn" class="p-2 bg-agri-500 text-white rounded-lg hover:bg-agri-600 disabled:opacity-40 disabled:cursor-not-allowed transition-all" disabled>
                        <i data-lucide="arrow-up" class="w-5 h-5"></i>
                    </button>
                </div>
                <div class="text-center mt-2">
                    <p class="text-[10px] text-gray-400">Agri AI can make mistakes. Verify important info.</p>
                </div>
            </div>
        </div>
    </main>

    <!-- RIGHT SIDEBAR (Tools) -->
    <aside id="tools-panel" class="fixed inset-y-0 right-0 z-50 w-80 bg-white border-l border-gray-200 transform translate-x-full lg:relative lg:translate-x-0 flex flex-col h-full lg:flex transition-transform duration-300">
        <div class="h-14 flex items-center justify-between px-4 border-b border-gray-100">
            <h2 class="font-semibold text-gray-800 text-sm">Assistant Tools</h2>
            <button onclick="app.toggleRight()" class="text-gray-400 hover:text-gray-600 lg:hidden"><i data-lucide="x" class="w-5 h-5"></i></button>
        </div>
        <div class="flex-1 overflow-y-auto p-4 space-y-6 bg-gray-50 custom-scroll">
            
            <!-- Weather Card Removed as requested -->

            <!-- Market Prices Card -->
            <div class="bg-white p-4 rounded-xl border border-gray-200 shadow-sm">
                <div class="flex items-center gap-2 mb-3 text-sm font-semibold text-gray-700"><i data-lucide="trending-up" class="w-4 h-4 text-green-600"></i> Market Prices</div>
                <div id="prices-list" class="space-y-2"></div>
            </div>

            <!-- Pesticides Prices Card -->
            <div class="bg-white p-4 rounded-xl border border-gray-200 shadow-sm">
                <div class="flex items-center gap-2 mb-3 text-sm font-semibold text-gray-700"><i data-lucide="flask-conical" class="w-4 h-4 text-purple-600"></i> Pesticides</div>
                <div id="pesticides-list" class="space-y-2 text-sm"></div>
            </div>

            <!-- Terrace Farming Card -->
            <div class="bg-white p-4 rounded-xl border border-gray-200 shadow-sm bg-gradient-to-br from-orange-50 to-white">
                <div class="flex items-center gap-2 mb-2 font-semibold text-sm text-gray-900"><i data-lucide="flower-2" class="w-4 h-4 text-orange-500"></i> Terrace Farming</div>
                <p class="text-xs text-gray-500 mb-3 leading-relaxed">Complete guide to soil mix, waterproofing, and container selection.</p>
                <button onclick="app.tool('plan')" class="w-full py-2 text-xs font-bold text-orange-700 bg-white border border-orange-100 rounded-lg hover:bg-orange-50 transition">View Guide</button>
            </div>

            <!-- Customer Support Card -->
            <div class="bg-white p-4 rounded-xl border border-gray-200 shadow-sm">
                <div class="flex items-center gap-2 mb-3 font-semibold text-sm text-gray-700"><i data-lucide="headset" class="w-4 h-4 text-blue-500"></i> Support 24/7</div>
                <div class="space-y-2">
                    <a href="tel:1800123" class="flex items-center gap-3 p-2 bg-gray-50 rounded-lg hover:bg-gray-100 transition text-xs font-medium text-gray-700"><i data-lucide="phone" class="w-3.5 h-3.5 text-gray-400"></i> 1800-123-AGRI</a>
                    <a href="mailto:support@agri.ai" class="flex items-center gap-3 p-2 bg-gray-50 rounded-lg hover:bg-gray-100 transition text-xs font-medium text-gray-700"><i data-lucide="mail" class="w-3.5 h-3.5 text-gray-400"></i> support@agri.ai</a>
                </div>
            </div>
        </div>
    </aside>

    <div id="voice-modal" class="fixed inset-0 bg-white/95 z-[60] hidden flex-col items-center justify-center transition-opacity opacity-0">
        <div class="relative w-32 h-32 flex items-center justify-center mb-8">
            <div class="w-20 h-20 bg-agri-500 rounded-full flex items-center justify-center voice-active text-white"><i data-lucide="mic" class="w-8 h-8"></i></div>
        </div>
        <h3 class="text-2xl font-semibold text-gray-800 mb-2">Listening...</h3>
        <button onclick="app.stopVoice()" class="mt-8 px-6 py-2 rounded-full border border-gray-300 hover:bg-gray-100 text-sm font-medium">Cancel</button>
    </div>

    <script>
        const API_KEY = "AIzaSyBmSCkr-MwYJL0D7eDyD9UhsSQmK-AZtZE"; 
        const MODEL = "gemini-2.5-flash";
        const $ = id => document.getElementById(id);
        const ls = localStorage;
        
        const app = {
            chatId: null, chats: JSON.parse(ls.getItem('agri_chats_v2') || '{}'), history: [], lang: 'en-US', media: null,
            init() {
                this.renderSidebar(); this.newChat(); this.updatePrices();
                if(window.innerWidth < 1024) { $('sidebar').classList.add('-translate-x-full'); $('mobile-overlay').classList.add('hidden'); }
                if(ls.getItem('pref_lang')) { $('lang-select').value = ls.getItem('pref_lang'); this.setLang(ls.getItem('pref_lang')); }
                lucide.createIcons();
            },
            toggleLeft() { 
                const sb = $('sidebar');
                if(window.innerWidth >= 1024) {
                    if(sb.classList.contains('sidebar-closed')) {
                        sb.classList.remove('sidebar-closed');
                    } else {
                        sb.classList.add('sidebar-closed');
                    }
                } else {
                    sb.classList.toggle('-translate-x-full'); $('mobile-overlay').classList.toggle('hidden');
                }
            },
            toggleRight() { const p = $('tools-panel'); if(window.innerWidth>=1024) { p.classList.toggle('lg:flex'); p.classList.toggle('lg:hidden'); } else { p.classList.toggle('translate-x-full'); } },
            setLang(l) { this.lang = l; ls.setItem('pref_lang', l); this.updatePrices(); },
            newChat() {
                this.chatId = Date.now().toString(); this.history = []; $('chat-history').innerHTML = ''; $('welcome-screen').classList.remove('hidden');
                this.clearFile(); this.renderSidebar(); if(window.innerWidth<1024) this.toggleLeft(); lucide.createIcons();
            },
            loadChat(id) {
                if(!this.chats[id]) return; this.chatId = id; this.history = this.chats[id].msgs || [];
                $('chat-history').innerHTML = ''; $('welcome-screen').classList.add('hidden');
                this.history.forEach(m => this.appendMsg(m.role, m.text, m.img));
                this.renderSidebar(); if(window.innerWidth<1024) this.toggleLeft();
            },
            renderSidebar() {
                const list = Object.entries(this.chats).sort((a,b)=>b[1].time-a[1].time);
                $('chat-list').innerHTML = `<div class="text-xs font-semibold text-gray-500 px-3 py-2">History</div>` + (list.length ? list.map(([id,c])=>`<button onclick="app.loadChat('${id}')" class="w-full text-left px-3 py-2 rounded-md hover:bg-white/10 text-sm text-gray-300 truncate transition ${id===this.chatId?'bg-white/10 text-white':''}">${c.title||'New Chat'}</button>`).join('') : '<div class="px-3 text-sm text-gray-500">No chats yet</div>');
            },
            handleFile(i) { const f=i.files[0]; if(!f)return; $('file-preview').classList.remove('hidden'); $('file-name').innerText=f.name; const r=new FileReader(); r.onload=e=>{this.media={data:e.target.result.split(',')[1],mime:f.type,url:e.target.result}; $('send-btn').disabled=false; $('send-btn').classList.remove('opacity-40');}; r.readAsDataURL(f); },
            clearFile() { this.media=null; $('file-upload').value=''; $('file-preview').classList.add('hidden'); },
            appendMsg(role, text, img) {
                $('welcome-screen').classList.add('hidden'); const u=role==='user';
                $('chat-history').insertAdjacentHTML('beforeend', `<div class="group w-full text-gray-800 border-b border-black/5 dark:border-white/5 ${u?'bg-white':'bg-gray-50'}"><div class="text-base gap-4 md:gap-6 md:max-w-2xl lg:max-w-xl xl:max-w-3xl flex p-4 m-auto"><div class="flex-shrink-0 flex flex-col relative items-end"><div class="w-6 h-6 rounded-sm flex items-center justify-center ${u?'bg-gray-500':'bg-agri-500'} text-white">${u?'U':'<i data-lucide="sprout" class="w-4 h-4"></i>'}</div></div><div class="relative flex-1 overflow-hidden"><div class="font-bold text-sm mb-1 opacity-90">${u?'You':'Agri AI'}</div><div class="prose prose-sm max-w-none leading-7">${text.replace(/\*\*(.*?)\*\*/g,'<b>$1</b>').replace(/\n/g,'<br>')}</div>${img?`<img src="${img}" class="mt-3 rounded-md max-h-60 border border-gray-200">`:''}</div></div></div>`);
                $('chat-container').scrollTop=$('chat-container').scrollHeight; lucide.createIcons();
            },
            async send() {
                const txt = $('user-input').value.trim(); if(!txt && !this.media) return;
                $('user-input').value=''; $('user-input').style.height='auto'; $('send-btn').disabled=true; $('send-btn').classList.add('opacity-40');
                this.history.push({role:'user',text:txt,img:this.media?this.media.url:null}); this.appendMsg('user',txt,this.media?this.media.url:null);
                const lid='l-'+Date.now(); $('chat-history').insertAdjacentHTML('beforeend', `<div id="${lid}" class="w-full bg-gray-50 p-4 border-b border-black/5"><div class="max-w-3xl m-auto flex gap-4"><div class="w-6 h-6 bg-agri-500 rounded-sm flex items-center justify-center text-white"><i data-lucide="sprout" class="w-4 h-4"></i></div><div class="animate-pulse flex gap-1 items-center text-gray-500">Thinking<span>.</span><span>.</span><span>.</span></div></div></div>`); $('chat-container').scrollTop=$('chat-container').scrollHeight; lucide.createIcons();
                try {
                    // Safe History Mapping
                    const ctx = this.history.slice(-6, -1).map(h => ({
                        role: h.role === 'user' ? 'user' : 'model',
                        parts: [{ text: h.text || " " }] // Ensure text is never empty
                    }));
                    
                    const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${MODEL}:generateContent?key=${API_KEY}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            contents: [...ctx, {
                                role: 'user',
                                parts: [
                                    { text: `You are Agri AI. Answer in ${this.lang}. Query: ${txt}` },
                                    ...(this.media ? [{ inlineData: { mimeType: this.media.mime, data: this.media.data } }] : [])
                                ]
                            }]
                        })
                    });
                    const d=await res.json(); 
                    $(lid).remove(); 
                    const r=d.candidates?.[0]?.content?.parts?.[0]?.text||"I couldn't process that request. Please try again.";
                    this.history.push({role:'model',text:r}); this.appendMsg('model',r);
                    this.chats[this.chatId]={title:this.history[0].text.substring(0,30)||"New Chat",msgs:this.history,time:Date.now()}; ls.setItem('agri_chats_v2',JSON.stringify(this.chats)); this.renderSidebar(); this.clearFile();
                } catch(e) { $(lid).remove(); this.appendMsg('model',"Connection Error. Please check your internet."); console.error(e); }
            },
            async tool(type) {
                // Immediate action without prompt
                let query = "";
                switch(type) {
                    case 'plan': query = "Help me create a crop plan. What details do you need?"; break;
                    case 'pest': query = "I need to identify a pest. I can upload a photo or describe it."; break;
                    case 'price': query = "What are the current market prices for common vegetables?"; break;
                    case 'tip': query = "Give me a valuable farming tip for the current season."; break;
                    case 'soil': query = "How can I analyze my soil? What crops are best for red soil?"; break;
                    case 'water': query = "Give me general irrigation advice for hot weather."; break;
                }
                if(query) { $('user-input').value = query; this.send(); }
            },
            updatePrices() {
                const p=[{n:'Tomato',p:'₹30/kg'},{n:'Onion',p:'₹25/kg'},{n:'Potato',p:'₹40/kg'}], pest=[{n:'Neem Oil',p:'₹450/L'},{n:'Imidacloprid',p:'₹800/L'}];
                $('prices-list').innerHTML=p.map(i=>`<div class="flex justify-between items-center p-2 rounded bg-gray-50"><span class="text-xs font-medium text-gray-700">${i.n}</span><span class="text-xs font-bold text-green-700 bg-green-50 px-2 py-1 rounded">${i.p}</span></div>`).join('');
                $('pesticides-list').innerHTML=pest.map(i=>`<div class="flex justify-between items-center p-2 rounded bg-gray-50"><span class="text-xs font-medium text-gray-700">${i.n}</span><span class="text-xs font-bold text-purple-700 bg-purple-50 px-2 py-1 rounded">${i.p}</span></div>`).join('');
                lucide.createIcons();
            },
            rec: ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) ? new (window.SpeechRecognition || window.webkitSpeechRecognition)() : null,
            toggleVoice() { if(!this.rec) return alert("Voice not supported."); $('voice-modal').classList.remove('hidden'); setTimeout(()=>$('voice-modal').classList.remove('opacity-0'),10); this.rec.lang=this.lang; this.rec.start(); },
            stopVoice() { if(this.rec) this.rec.stop(); $('voice-modal').classList.add('opacity-0'); setTimeout(()=>$('voice-modal').classList.add('hidden'),300); }
        };
        
        if(app.rec) { app.rec.onresult=e=>{ $('user-input').value=e.results[0][0].transcript; app.stopVoice(); app.send(); }; app.rec.onerror=()=>app.stopVoice(); }
        app.init();
        $('user-input').addEventListener('input', e=> { $('send-btn').disabled=!e.target.value.trim(); if(e.target.value.trim()) $('send-btn').classList.remove('opacity-40'); else $('send-btn').classList.add('opacity-40'); });
    </script>
</body>
</html>
